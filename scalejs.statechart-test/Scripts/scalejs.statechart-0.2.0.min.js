define("scalejs.statechart/transition",["scalejs!core"],function(e,t){var n=e.object.has,r=e.linq.enumerable;return function(e,t,i){function s(){var t,s;return n(e,"event")?e.event==="*"?[e.event]:(s=e.event.trim().split(/\s+/),t=r.from(s).select(function(e){return e.indexOf(".*",e.length-2)>=0?e.indexOf(0,e.length-2):e}).filter('$ !== "*"').forEach(function(e){i.uniqueEvents[e]=!0}).toArray(),t):undefined}function o(){return e.condition}function u(){if(n(e,"target"))return e.target.trim().split(/\s+/)}function a(){return e.action}var f={events:s(),condition:o(),source:t.id,targets:u(),action:a(),documentOrder:i.transitions.length,id:i.transitions.length};return i.transitions.push(f),f}}),define("scalejs.statechart/state",["scalejs!core","./transition"],function(e,t){var n=e.object.has,r=e.linq.enumerable,i=e.array,s=0,o={BASIC:0,COMPOSITE:1,PARALLEL:2,HISTORY:3,INITIAL:4,FINAL:5};return function u(e,a,f){function c(){var t;if(n(e,"id")){if(f.idToStateMap.hasOwnProperty(e.id))throw{name:"Illegal Argument",message:"Duplicate state id `"+e.id+"`. State id-s must be unique."};t=e.id}else s+=1,t=s;f.idToStateMap[t]=l}function h(){return n(u,"states")?o.COMPOSITE:u.parallel?o.PARALLEL:u.history?o.HISTORY:u.initial?o.INITIAL:u.final?o.FINAL:o.BASIC}function p(){if(!n(e,"transitions"))return[];var i=r.from(e.transitions).select(function(e){var n=t(e,l,f);return n.id}).toArray();return i}function d(){return a.length>0?a[a.length-1]:undefined}function v(){return f.states.push(l),f.states.length-1}function m(){if(l.kind===o.BASIC||l.kind===o.INITIAL||l.kind===o.HISTORY)return f.basicStates.push(l),f.basicStates.length-1}function g(){if(!n(e,"states"))return[];var t=r.from(e.children).select(function(e){return u(e,f)}).toArray();return t}var l={};return l.id=c(),l.kind=h(),l.children=g(),l.transitions=p(),l.onEntry=e.onEntry,l.onExit=e.onExit,l.parent=d(),l.documentOrder=v(),l.basicDocumentOrder=m(),l.depth=a.length,l.ancestors=a.slice(),i.iter(a,function(e){f.idToStateMap[e].descendants.push(l.id)}),l}}),define("scalejs.statechart/model",["scalejs!core","./state"],function(e,t){var n=e.object.has,r=e.linq.enumerable;return function(n){var r={states:[],basicStates:[],uniqueEvents:{},transitions:[],idToStateMap:{},onFoundStateIdCallbacks:[]},i=t(n,[],r);return{root:i}}}),define("scalejs.statechart/statechart",["scalejs!core","./model"],function(e,t){function o(){return function(e){var t=e[0],n=e[1];return t.source.depth<n.source.depth?n:n.source.depth<t.source.depth?t:t.documentOrder<n.documentOrder?t:n}}function u(e,t,n){return r.filter(e.transitions,function(e){return!e.event||t.indexOf(e.event)>-1&&(!e.cond||n(e))})}var n=e.log.debug,r=e.array,i=e.linq.enumerable,s={BASIC:0,COMPOSITE:1,PARALLEL:2,HISTORY:3,INITIAL:4,FINAL:5};return function(a){function T(e,t){var r=e.targets?e.lca:e.source,i=t.targets?t.lca:t.source,s=f.isOrthogonalTo(r,i);return g&&(n("transition LCAs",r.id,i.id),n("transition LCAs are orthogonal?",s)),s}function N(e,t){return!T(e,t)}function C(e){var t=[],n=[],i,s,o,u,a;for(i=0;i<e.length;i+=1)for(s=i+1;s<e.length;s+=1)o=e[i],u=e[s],N(o,u)&&(r.addOne(t,o),r.addOne(t,u),r.addOne(n,[o,u]));return a=e.difference(t),[a,n]}function k(e){var t=[],r=C(e),s=r[0],o=r[1];t.union(s),g&&(n("enabledTransitions",e),n("consistentTransitions",s),n("inconsistentTransitionsPairs",o),n("priorityEnabledTransitions",t));while(!o.isEmpty())e=i.from(o).select(l),r=C(e),s=r[0],o=r[1],t.union(s),g&&(n("enabledTransitions",e),n("consistentTransitions",s),n("inconsistentTransitionsPairs",o),n("priorityEnabledTransitions",t));return t}function L(e,t,n){var r=b[t];if(!r)throw new Error("Variable "+t+" not declared in datamodel.");return r[e](n)}function A(e){return L("get",e)}function O(e,t){return L("set",e,t)}function M(e,t,n){return{setData:n?function(t,n){e[t]=n}:function(){},getData:A,events:t}}function _(e,t){var r,s,o,a,l,h,p,d;return S?r=i.from(c):r=i.from(c).selectMany(function(e){var t=f.getAncestors(e);return i.returnValue(e).concat(t)}),s=M(t,e),o=function(e){return y[e.conditionActionRef].call(E,s.getData,s.setData,s.events)},a=i.from(e).select("$.name"),l=a.any(function(e){return e.search(".")}),h=u,p=r.selectMany(function(e){return h(e,a,o)}),d=k(p),g&&n("priorityEnabledTransitions",d),d}function D(e){var t=[],n=[],s=[];return r.iter(e,function(e){var i=e.lca,s=i.descendants;r.iter(c,function(e){s.indexOf(e)>-1&&(n.add(e),t.add(e),r.iter(f.getAncestors(e,i),function(e){t.add(e)}))})}),s=i.from(t).orderBy("$.depth").toArray(),[n,s]}function P(e,t,n,r){function i(e){r.add(e)}var s=M(n,t,!0);return y[e].call(E,s.getData,s.setData,s.events,i)}function H(e){var t=[],n=[],r=[],i=[],o,u,a,l;u=function(e,n){o(n);var i=f.getLCA(e,n);f.getAncestors(n,i).forEach(function(e){e.kind===s.COMPOSITE?(t.add(e),r.add(e)):o(e)})},o=function(e){if(r.contains(e))return;e.kind===s.HISTORY?h.hasOwnProperty(e.id)?h[e.id].forEach(function(t){u(e,t)}):(t.add(e),n.add(e)):(t.add(e),e.kind===s.PARALLEL?i.push.apply(i,e.children.filter(function(e){return e.kind!==s.HISTORY})):e.kind===s.COMPOSITE?i.push(e.initial):(e.kind===s.INITIAL||e.kind===s.BASIC||e.kind===s.FINAL)&&n.add(e)),r.add(e)},e.iter().forEach(function(e){e.targets.forEach(function(t){u(e.source,t)})});while((a=i.pop())!==undefined)o(a);return l=t.iter().sort(function(e,t){return e.depth-t.depth}),[n,l]}function B(e,t){var o,u,a,f,l,d,v,y,b,w,E;g&&n("selecting transitions with eventSet: ",e),o=_(e,t),g&&n("selected transitions: ",o);if(!o.isEmpty()){g&&n("sorted transitions: ",o),u=i.from(o).where("$.targets"),a=D(u),f=a[0],l=a[1],d=H(u),v=d[0],y=d[1],g&&(n("basicStatesExited ",f),n("basicStatesEntered ",v),n("statesExited ",l),n("statesEntered ",y)),b=[],g&&n("executing state exit actions"),r.iter(l,function(i){(g||x)&&n("exiting ",i.id),r.iter(m,function(e){e.onExit&&e.onExit(i.id)}),i.onexit!==undefined&&P(i.onexit,e,t,b);var o;i.history&&(i.history.isDeep?o=function(e){return e.kind===s.BASIC&&i.descendants.indexOf(e)>-1}:o=function(e){return e.parent===i},h[i.history.id]=l.filter(o))}),w=o.iter().sort(function(e,t){return e.documentOrder-t.documentOrder}),g&&n("executing transitition actions"),w.forEach(function(n){var s=n.targets&&i.from(n.targets).select("$.id").toArray();r.iter(m,function(e){e.onTransition&&e.onTransition(n.source.id,s)}),n.actions!==undefined&&P(n.actions,e,t,b)}),g&&n("executing state enter actions"),r.iter(y,function(i){(g||this.opts.logStatesEnteredAndExited)&&n("entering",i.id),r.iter(m,function(e){e.onEntry&&e.onEntry(i.id)}),i.onentry!==undefined&&P(i.onentry,e,t,b)}),g&&(n("updating configuration "),n("old configuration ",c)),c.difference(f),c.union(v),g&&n("new configuration ",c),b.isEmpty()||(g&&n("adding triggered events to inner queue ",b),p.push(b)),g&&n("updating datamodel for next small step :");for(E in t)t.hasOwnProperty(E)&&O(E,t[E])}return o}function j(e){e&&p.push([e]);var t=!0,n,r,i;while(t)n=p.length>0?p.shift():[],r={},i=B(n,r),t=!i.isEmpty();d=c.iter().every(function(e){return e.kind===s.FINAL})}function F(){return i.from(c).select("$.id").toArray()}function I(e,t){var n;switch(typeof e){case"string":n={name:e,data:t};break;case"object":if(typeof e.name!="string")throw new Error('Event object must have "name" property of type string.');n=e;break;default:throw new Error("First argument to gen must be a string or object.")}if(w)throw new Error("gen called before previous call to gen could complete. If executed in single-threaded environment, this means it was called recursively,which is illegal, as it would break SCION step semantics.");return w=!0,j(n),w=!1,F()}function q(e,t){var r,i;if(!setTimeout)throw new Error("setTimeout function not set");g&&n("sending event",e.name,"with content",e.data,"after delay",t.delay),r=function(){return I(e)},i=setTimeout(r,t.delay),t.sendid&&(v[t.sendid]=i)}function R(e){if(!clearTimeout)throw new Error("clearTimeout function not set");if(v.hasOwnProperty(e))return g&&n("cancelling ",e," with timeout id ",v[e]),clearTimeout(v[e])}function U(){return g&&n("performing initial big step"),c.add(f.root.initial),y=[],b={},j(),F()}var f=t(a),l=o(f),c=[],h,p,d=!1,v={},m=[],g=!0,y=[],b={},w=!1,E,S=!1,x=!1;return{start:U,send:q,cancel:R}}}),define("scalejs.statechart",["scalejs!core","./scalejs.statechart/statechart"],function(e,t){e.registerExtension({statechart:t})});