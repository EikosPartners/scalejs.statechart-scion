define("scalejs.statechart/stateKinds",{BASIC:0,COMPOSITE:1,PARALLEL:2,HISTORY:3,INITIAL:4,FINAL:5}),define("scalejs.statechart/transition",["scalejs!core"],function(e,t){var n=e.object.has,r=e.linq.enumerable;return function(e,t,i){function s(){var t,s;return n(e,"event")?e.event==="*"?[e.event]:(s=e.event.trim().split(/\s+/),t=r.from(s).select(function(e){return e.indexOf(".*",e.length-2)>=0?e.indexOf(0,e.length-2):e}).filter('$ !== "*"').forEach(function(e){i.uniqueEvents[e]=!0}).toArray(),t):undefined}function o(){return e.condition}function u(){return n(e,"target")?e.target.trim().split(/\s+/):[]}function a(){return e.action}var f={events:s(),condition:o(),source:t.id,targets:u(),action:a(),documentOrder:i.transitions.length,id:i.transitions.length};return i.transitions.push(f),f}}),define("scalejs.statechart/state",["scalejs!core","./stateKinds","./transition"],function(e,t,n){var r=e.object.has,i=e.linq.enumerable,s=e.array;return function o(e,u,a){function c(e){var t=l[e]||0,n=t+1,r=e+"_"+n;return l[e]=n,r}function h(){var t,n;if(r(e,"id")){if(a.idToStateMap.hasOwnProperty(e.id))throw{name:"Illegal Argument",message:"Duplicate state id `"+e.id+"`. State id-s must be unique."};t=e.id}else t=c(e.initial===!0?"initial":"state");return a.idToStateMap[t]=f,t}function p(){return r(e,"states")?t.COMPOSITE:e.parallel?t.PARALLEL:e.history?t.HISTORY:e.initial===!0?t.INITIAL:e.final?t.FINAL:t.BASIC}function d(){if(!r(e,"transitions"))return[];var t=i.from(e.transitions).select(function(e){var t=n(e,f,a);return t.id}).toArray();return t}function v(){return u.length>0?u[u.length-1]:undefined}function m(){return a.states.push(f),a.states.length-1}function g(){if(f.kind===t.BASIC||f.kind===t.INITIAL||f.kind===t.HISTORY)return a.basicStates.push(f),a.basicStates.length-1}function y(){if(!r(e,"states"))return[];var t=u.concat(f.id),n=i.from(e.states).select(function(e){var n=o(e,t,a);return n.id}).toArray();return n}function b(){var n,r,i=s.filter(f.children,function(e){return e.kind===t.INITIAL});if(i.length>1)throw new Error('Duplicate initial states in state "'+f.id+'".');return i.length===1?i[0].id:f.kind===t.PARALLEL||f.children.length===0?undefined:(r=e.initial||f.children[0],n=o({initial:!0,transitions:[{target:r}]},u.concat(f.id),a),f.children.push(n),n.id)}var f={},l={};return f.id=h(),f.kind=p(),f.descendants=[],f.children=y(),f.transitions=d(),f.initial=b(),f.onEntry=e.onEntry,f.onExit=e.onExit,f.parent=v(),f.documentOrder=m(),f.basicDocumentOrder=g(),f.depth=u.length,f.ancestors=u.slice(),s.iter(u,function(e){a.idToStateMap[e].descendants.push(f.id)}),f}}),define("scalejs.statechart/model",["scalejs!core","./state","./stateKinds"],function(e,t,n){var r=e.object.has,i=e.linq.enumerable,s=e.array;return function(o){function f(e){return u.idToStateMap[e]}function l(e,t){var n,r,i;return r=e.ancestors.indexOf(t),r>-1?e.ancestors.slice(0,r):e.ancestors}function c(e,t){return[e].concat(l(e,t))}function h(e){return[e].concat(e.descendants)}function p(e,t){return c(t).indexOf(e)>-1||c(e).indexOf(t)>-1}function d(e,t){var n=i.from(l(e)).firstOrDefault(null,function(e){return e.descendants.indexOf(t)>-1});return n}function v(e,t){return!p(e,t)&&d(e,t).kind===n.PARALLEL}var u={states:[],basicStates:[],uniqueEvents:{},transitions:[],idToStateMap:{},onFoundStateIdCallbacks:[]},a;return a=t(o,[],u),s.iter(u.states,function(e){e.ancestors.reverse(),e.descendants.reverse(),e.initial=f(e.initial),e.history=f(e.history),e.children=s.map(e.children,f),e.parent=f(e.parent),e.ancestors=s.map(e.ancestors,f),e.descendants=s.map(e.descendants,f)}),s.iter(u.transitions,function(e){e.source=f(e.source),e.targets=s.map(e.targets,function(e){var t=f(e);if(!r(t))throw new Error('Transition targets state "'+e+"\" but such state doesn't exist.");return t}),e.targets.length>0&&(e.lca=d(e.source,e.targets[0]))}),{root:a,getLCA:d,getAncestorsOrSelf:c}}}),define("scalejs.statechart/statechart",["scalejs!core","./model","./stateKinds"],function(e,t,n){function o(){return function(e){var t=e[0],n=e[1];return t.source.depth<n.source.depth?n:n.source.depth<t.source.depth?t:t.documentOrder<n.documentOrder?t:n}}function u(e,t,n){return i.filter(e.transitions,function(e){return!e.event||t.indexOf(e.event)>-1&&(!e.cond||n(e))})}var r=e.log.debug,i=e.array,s=e.linq.enumerable;return function(a){function T(e,t){var n=e.targets?e.lca:e.source,i=t.targets?t.lca:t.source,s=f.isOrthogonalTo(n,i);return g&&(r("transition LCAs",n.id,i.id),r("transition LCAs are orthogonal?",s)),s}function N(e,t){return!T(e,t)}function C(e){var t=[],n=[],r,s,o,u,a;for(r=0;r<e.length;r+=1)for(s=r+1;s<e.length;s+=1)o=e[r],u=e[s],N(o,u)&&(i.addOne(t,o),i.addOne(t,u),i.addOne(n,[o,u]));return a=e.difference(t),[a,n]}function k(e){var t=[],n=C(e),i=n[0],o=n[1];t.union(i),g&&(r("enabledTransitions",e),r("consistentTransitions",i),r("inconsistentTransitionsPairs",o),r("priorityEnabledTransitions",t));while(!o.isEmpty())e=s.from(o).select(l),n=C(e),i=n[0],o=n[1],t.union(i),g&&(r("enabledTransitions",e),r("consistentTransitions",i),r("inconsistentTransitionsPairs",o),r("priorityEnabledTransitions",t));return t}function L(e,t,n){var r=b[t];if(!r)throw new Error("Variable "+t+" not declared in datamodel.");return r[e](n)}function A(e){return L("get",e)}function O(e,t){return L("set",e,t)}function M(e,t,n){return{setData:n?function(t,n){e[t]=n}:function(){},getData:A,events:t}}function _(e,t){var n,i,o,a,l,h,p,d;return S?n=s.from(c):n=s.from(c).selectMany(function(e){var t=f.getAncestors(e);return s.returnValue(e).concat(t)}),i=M(t,e),o=function(e){return y[e.conditionActionRef].call(E,i.getData,i.setData,i.events)},a=s.from(e).select("$.name"),l=a.any(function(e){return e.search(".")}),h=u,p=n.selectMany(function(e){return h(e,a,o)}),d=k(p),g&&r("priorityEnabledTransitions",d),d}function D(e){var t=[],n=[],r=[];return i.iter(e,function(e){var r=e.lca,s=r.descendants;i.iter(c,function(e){s.indexOf(e)>-1&&(n.add(e),t.add(e),i.iter(f.getAncestors(e,r),function(e){t.add(e)}))})}),r=s.from(t).orderBy("$.depth").toArray(),[n,r]}function P(e,t,n,r){function i(e){r.add(e)}var s=M(n,t,!0);return y[e].call(E,s.getData,s.setData,s.events,i)}function H(e){var t=[],r=[],i=[],s=[],o,u,a,l;u=function(e,r){o(r);var s=f.getLCA(e,r);f.getAncestors(r,s).forEach(function(e){e.kind===n.COMPOSITE?(t.add(e),i.add(e)):o(e)})},o=function(e){if(i.contains(e))return;e.kind===n.HISTORY?h.hasOwnProperty(e.id)?h[e.id].forEach(function(t){u(e,t)}):(t.add(e),r.add(e)):(t.add(e),e.kind===n.PARALLEL?s.push.apply(s,e.children.filter(function(e){return e.kind!==n.HISTORY})):e.kind===n.COMPOSITE?s.push(e.initial):(e.kind===n.INITIAL||e.kind===n.BASIC||e.kind===n.FINAL)&&r.add(e)),i.add(e)},e.iter().forEach(function(e){e.targets.forEach(function(t){u(e.source,t)})});while((a=s.pop())!==undefined)o(a);return l=t.iter().sort(function(e,t){return e.depth-t.depth}),[r,l]}function B(e,t){var o,u,a,f,l,d,v,y,b,w,E;g&&r("selecting transitions with eventSet: ",e),o=_(e,t),g&&r("selected transitions: ",o);if(!o.isEmpty()){g&&r("sorted transitions: ",o),u=s.from(o).where("$.targets"),a=D(u),f=a[0],l=a[1],d=H(u),v=d[0],y=d[1],g&&(r("basicStatesExited ",f),r("basicStatesEntered ",v),r("statesExited ",l),r("statesEntered ",y)),b=[],g&&r("executing state exit actions"),i.iter(l,function(s){(g||x)&&r("exiting ",s.id),i.iter(m,function(e){e.onExit&&e.onExit(s.id)}),s.onexit!==undefined&&P(s.onexit,e,t,b);var o;s.history&&(s.history.isDeep?o=function(e){return e.kind===n.BASIC&&s.descendants.indexOf(e)>-1}:o=function(e){return e.parent===s},h[s.history.id]=l.filter(o))}),w=o.iter().sort(function(e,t){return e.documentOrder-t.documentOrder}),g&&r("executing transitition actions"),w.forEach(function(n){var r=n.targets&&s.from(n.targets).select("$.id").toArray();i.iter(m,function(e){e.onTransition&&e.onTransition(n.source.id,r)}),n.actions!==undefined&&P(n.actions,e,t,b)}),g&&r("executing state enter actions"),i.iter(y,function(n){(g||this.opts.logStatesEnteredAndExited)&&r("entering",n.id),i.iter(m,function(e){e.onEntry&&e.onEntry(n.id)}),n.onentry!==undefined&&P(n.onentry,e,t,b)}),g&&(r("updating configuration "),r("old configuration ",c)),c.difference(f),c.union(v),g&&r("new configuration ",c),b.isEmpty()||(g&&r("adding triggered events to inner queue ",b),p.push(b)),g&&r("updating datamodel for next small step :");for(E in t)t.hasOwnProperty(E)&&O(E,t[E])}return o}function j(e){e&&p.push([e]);var t=!0,r,i,s;while(t)r=p.length>0?p.shift():[],i={},s=B(r,i),t=!s.isEmpty();d=c.iter().every(function(e){return e.kind===n.FINAL})}function F(){var e=s.from(c).select("$.id").toArray();return e}function I(){var e=s.from(c).selectMany(function(e){return f.getAncestorsOrSelf(e)}).select("$.id").distinct().toArray();return e}function q(e,t){var n;switch(typeof e){case"string":n={name:e,data:t};break;case"object":if(typeof e.name!="string")throw new Error('Event object must have "name" property of type string.');n=e;break;default:throw new Error("First argument to gen must be a string or object.")}if(w)throw new Error("gen called before previous call to gen could complete. If executed in single-threaded environment, this means it was called recursively,which is illegal, as it would break SCION step semantics.");return w=!0,j(n),w=!1,F()}function R(e,t){var n,i;if(!setTimeout)throw new Error("setTimeout function not set");g&&r("sending event",e.name,"with content",e.data,"after delay",t.delay),n=function(){return q(e)},i=setTimeout(n,t.delay),t.sendid&&(v[t.sendid]=i)}function U(e){if(!clearTimeout)throw new Error("clearTimeout function not set");if(v.hasOwnProperty(e))return g&&r("cancelling ",e," with timeout id ",v[e]),clearTimeout(v[e])}function z(){return g&&r("performing initial big step"),j(),F()}var f=t(a),l=o(f),c=[],h,p=[],d=!1,v={},m=[],g=!0,y=[],b={},w=!1,E,S=!1,x=!1;return c.push(f.root.initial||f.root),{start:z,send:R,cancel:U,getConfiguration:F,getFullConfiguration:I}}}),define("scalejs.statechart",["scalejs!core","./scalejs.statechart/statechart"],function(e,t){e.registerExtension({statechart:t})});