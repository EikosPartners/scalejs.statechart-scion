!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define("scion-ng",b):a.SCION=b()}(this,function(){"use strict";function a(a){function b(a){void 0===l[a]&&(l[a]=0);var b=l[a]++;return"$generated-"+a+"-"+b}function c(a){return{states:[{type:"initial",transitions:[{target:a}]},a]}}function d(a,c){if(c.transitions&&i.push.apply(i,c.transitions),c.id){if(j[c.id])throw new Error("Redefinition of state id "+c.id);j[c.id]=c}c.type=c.type||"state",c.ancestors=a,c.depth=a.length,c.parent=a[0],c.transitions=c.transitions||[],c.transitions.forEach(function(a){a.documentOrder=k++,a.source=c});var e=d.bind(null,[c].concat(a));switch(c.states&&c.states.forEach(e),c.type){case"parallel":c.typeEnum=f.PARALLEL;break;case"initial":c.typeEnum=f.INITIAL;break;case"history":c.typeEnum=f.HISTORY;break;case"final":c.typeEnum=f.FINAL;break;case"state":case"scxml":c.states&&c.states.length?c.typeEnum=f.COMPOSITE:c.typeEnum=f.BASIC;break;default:throw new Error("Unknown state type: "+c.type)}c.states?c.descendants=c.states.concat(c.states.map(function(a){return a.descendants}).reduce(function(a,b){return a.concat(b)},[])):c.descendants=[];var g;if(c.typeEnum===f.COMPOSITE&&("string"==typeof c.initial?(g=c.states.filter(function(a){return a.id===c.initial}),g.length&&(c.initialRef=g[0])):(g=c.states.filter(function(a){return"initial"===a.type}),c.initialRef=g.length?g[0]:c.states[0]),!c.initialRef))throw new Error("Unable to locate initial state for composite state: "+c.id);if(c.typeEnum===f.COMPOSITE||c.typeEnum===f.PARALLEL){var h=c.states.filter(function(a){return"history"===a.type});c.historyRef=h[0]}c.id||(c.id=b(c.type),j[c.id]=c),["onEntry","onExit"].forEach(function(a){"function"==typeof c[a]&&(c[a]=[c[a]])})}function e(){i.forEach(function(a){"function"==typeof a.onTransition&&(a.onTransition=[a.onTransition])}),i.forEach(function(a){a.event&&(a.events=a.event.trim().split(/ +/))}),i.forEach(function(a){if(!a.targets&&"undefined"!=typeof a.target)if("string"==typeof a.target){var b=j[a.target];if(!b)throw new Error("Unable to find target state with id "+a.target);a.target=b,a.targets=[a.target]}else if(Array.isArray(a.target))a.targets=a.target.map(function(b){if("string"==typeof b){if(b=j[b],!b)throw new Error("Unable to find target state with id "+a.target);return b}return b});else{if("object"!=typeof a.target)throw new Error("Transition target has unknown type: "+a.target);a.targets=[a.target]}}),i.forEach(function(a){a.targets&&(a.lcca=h(a.source,a.targets[0])),a.scope=g(a)})}function g(a){var b="internal"===a.type&&a.source.parent&&a.targets&&a.targets.every(function(b){return a.source.descendants.indexOf(b)>-1});return a.targets?b?a.source:a.lcca:a.source}function h(a,b){var c=[];if(a.ancestors.forEach(function(a){a.typeEnum===f.COMPOSITE&&a.descendants.indexOf(b)>-1&&c.push(a)}),!c.length)throw new Error("Could not find LCA for states.");return c[0]}var i=[],j={},k=0,l={},m=c(a);return d([],m),e(),m}function b(a){a=a||[],this.o=[],a.forEach(function(a){this.add(a)},this)}function c(a){var b=a[0],c=a[1];return b.source.depth<c.source.depth?c:c.source.depth<b.source.depth?b:b.documentOrder<c.documentOrder?b:c}function d(d,e){this._model=a(d),this.opts=e||{},this.opts.log=e.log||("undefined"==typeof console?{log:function(){}}:console.log.bind(console)),this.opts.Set=this.opts.Set||b,this.opts.priorityComparisonFn=this.opts.priorityComparisonFn||c,this.opts.transitionSelector=this.opts.transitionSelector||g,this._sessionid=this.opts.sessionid||"",this._configuration=new this.opts.Set,this._historyValue={},this._internalEventQueue=[],this._isInFinalState=!1,this._timeoutMap={},this._x={_sessionId:e.sessionId||null,_name:d.name||e.name||null,_ioprocessors:e.ioprocessors||null},this._listeners=[],this._userScriptingContext={raise:function(a,b){var c;c="string"==typeof a?{name:a,data:b}:a,this._internalEventQueue.push(c)}.bind(this),send:function(){this.send.apply(this,arguments)}.bind(this),cancel:function(){this.cancel.apply(this,arguments)}.bind(this)}}function e(a,b){b=b||{},this._isStepping=!1,this._externalEventQueue=[],this.send=b.send||this.send,this.cancel=b.cancel||this.cancel,d.call(this,a,b)}var f={BASIC:0,COMPOSITE:1,PARALLEL:2,HISTORY:3,INITIAL:4,FINAL:5};b.prototype={add:function(a){return this.contains(a)?void 0:this.o.push(a)},remove:function(a){var b=this.o.indexOf(a);return-1===b?!1:(this.o.splice(b,1),!0)},union:function(a){return a=a.iter?a.iter():a,a.forEach(function(a){this.add(a)},this),this},difference:function(a){return a=a.iter?a.iter():a,a.forEach(function(a){this.remove(a)},this),this},contains:function(a){return this.o.indexOf(a)>-1},iter:function(){return this.o},isEmpty:function(){return!this.o.length},equals:function(a){var b=a.iter(),c=this.o;return c.every(function(a){return b.indexOf(a)>-1})&&b.every(function(a){return c.indexOf(a)>-1})},toString:function(){return"Set("+this.o.toString()+")"}};var g=function(){function a(a){return new RegExp("^"+a.replace(/\./g,"\\.")+"(\\.[0-9a-zA-Z]+)*$")}function b(b){return d[b]?d[b]:d[b]=a(b)}function c(a,c){return c&&c.name&&(a.events.indexOf("*")>-1?!0:a.events.filter(function(a){return b(a).test(c.name)}).length)}var d={};return function(a,b,d){return a.transitions.filter(function(a){return(!a.events||c(a,b))&&(!a.cond||d(a.cond))})}}(),h={getAncestors:function(a,b){var c;return c=a.ancestors.indexOf(b),c>-1?a.ancestors.slice(0,c):a.ancestors},getAncestorsOrSelf:function(a,b){return[a].concat(this.getAncestors(a,b))},getDescendantsOrSelf:function(a){return[a].concat(a.descendants)},isOrthogonalTo:function(a,b){return!this.isAncestrallyRelatedTo(a,b)&&this.getLCA(a,b).typeEnum===f.PARALLEL},isAncestrallyRelatedTo:function(a,b){return this.getAncestorsOrSelf(b).indexOf(a)>-1||this.getAncestorsOrSelf(a).indexOf(b)>-1},getLCA:function(a,b){var c=this.getAncestors(a).filter(function(a){return a.descendants.indexOf(b)>-1},this);return c[0]}},i=!1;return d.prototype={start:function(){return i&&this.opts.log("performing initial big step"),this._configuration.add(this._model.initialRef),this._performBigStep(),this.getConfiguration()},getConfiguration:function(){return this._configuration.iter().map(function(a){return a.id})},getFullConfiguration:function(){return this._configuration.iter().map(function(a){return[a].concat(h.getAncestors(a))},this).reduce(function(a,b){return a.concat(b)},[]).map(function(a){return a.id}).reduce(function(a,b){return a.indexOf(b)>-1?a:a.concat(b)},[])},isIn:function(a){return this.getFullConfiguration().indexOf(a)>-1},isFinal:function(a){return this._isInFinalState},_performBigStep:function(a){a&&this._internalEventQueue.push(a);for(var b=!0;b;){var c=this._internalEventQueue.shift()||null,d=this._performSmallStep(c);b=!d.isEmpty()}this._isInFinalState=this._configuration.iter().every(function(a){return a.typeEnum===f.FINAL})},_performSmallStep:function(a){i&&this.opts.log("selecting transitions with currentEvent: ",a);var b=this._selectTransitions(a);if(i&&this.opts.log("selected transitions: ",b),!b.isEmpty()){i&&this.opts.log("sorted transitions: ",b);var c=new this.opts.Set(b.iter().filter(function(a){return a.targets})),d=this._getStatesExited(c),e=d[0],g=d[1],h=this._getStatesEntered(c),j=h[0],k=h[1];i&&this.opts.log("basicStatesExited ",e),i&&this.opts.log("basicStatesEntered ",j),i&&this.opts.log("statesExited ",g),i&&this.opts.log("statesEntered ",k);var l=new this.opts.Set;i&&this.opts.log("executing state exit actions");var m=this._evaluateAction.bind(this,a);g.forEach(function(a){(i||this.opts.logStatesEnteredAndExited)&&this.opts.log("exiting ",a.id),this._listeners.forEach(function(b){b.onExit&&b.onExit(a.id)}),void 0!==a.onExit&&a.onExit.forEach(m);var b;a.historyRef&&(b=a.historyRef.isDeep?function(b){return b.typeEnum===f.BASIC&&a.descendants.indexOf(b)>-1}:function(b){return b.parent===a},this._historyValue[a.historyRef.id]=g.filter(b))},this);var n=b.iter().sort(function(a,b){return a.documentOrder-b.documentOrder});i&&this.opts.log("executing transitition actions"),n.forEach(function(a){var b=a.targets&&a.targets.map(function(a){return a.id});this._listeners.forEach(function(c){c.onTransition&&c.onTransition(a.source.id,b)}),void 0!==a.onTransition&&a.onTransition.forEach(m)},this),i&&this.opts.log("executing state enter actions"),k.forEach(function(a){(i||this.opts.logStatesEnteredAndExited)&&this.opts.log("entering",a.id),void 0!==a.onEntry&&a.onEntry.forEach(m),this._listeners.forEach(function(b){b.onEntry&&m(function(c){b.onEntry.call(this,a.id,c)})})},this),i&&this.opts.log("updating configuration "),i&&this.opts.log("old configuration ",this._configuration),this._configuration.difference(e),this._configuration.union(j),i&&this.opts.log("new configuration ",this._configuration),l.isEmpty()||(i&&this.opts.log("adding triggered events to inner queue ",l),this._internalEventQueue.push(l))}return b},_evaluateAction:function(a,b){return b.call(this._userScriptingContext,a,this.isIn.bind(this),this._x._sessionId,this._x._name,this._x._ioprocessors,this._x)},_getStatesExited:function(a){var b=new this.opts.Set,c=new this.opts.Set;a.iter().forEach(function(a){var d=a.scope,e=d.descendants;this._configuration.iter().forEach(function(a){e.indexOf(a)>-1&&(c.add(a),b.add(a),h.getAncestors(a,d).forEach(function(a){b.add(a)}))},this)},this);var d=b.iter().sort(function(a,b){return b.depth-a.depth});return[c,d]},_getStatesEntered:function(a){var b={statesToEnter:new this.opts.Set,basicStatesToEnter:new this.opts.Set,statesProcessed:new this.opts.Set,statesToProcess:[]};a.iter().forEach(function(a){a.targets.forEach(function(c){this._addStateAndAncestors(c,a.scope,b)},this)},this);for(var c;c=b.statesToProcess.pop();)this._addStateAndDescendants(c,b);var d=b.statesToEnter.iter().sort(function(a,b){return a.depth-b.depth});return[b.basicStatesToEnter,d]},_addStateAndAncestors:function(a,b,c){this._addStateAndDescendants(a,c),h.getAncestors(a,b).forEach(function(a){a.typeEnum===f.COMPOSITE?(c.statesToEnter.add(a),c.statesProcessed.add(a)):this._addStateAndDescendants(a,c)},this)},_addStateAndDescendants:function(a,b){b.statesProcessed.contains(a)||(a.typeEnum===f.HISTORY?a.id in this._historyValue?this._historyValue[a.id].forEach(function(c){this._addStateAndAncestors(c,a.parent,b)},this):(b.statesToEnter.add(a),b.basicStatesToEnter.add(a)):(b.statesToEnter.add(a),a.typeEnum===f.PARALLEL?b.statesToProcess.push.apply(b.statesToProcess,a.states.filter(function(a){return a.typeEnum!==f.HISTORY})):a.typeEnum===f.COMPOSITE?b.statesToProcess.push(a.initialRef):(a.typeEnum===f.INITIAL||a.typeEnum===f.BASIC||a.typeEnum===f.FINAL)&&b.basicStatesToEnter.add(a)),b.statesProcessed.add(a))},_selectTransitions:function(a){if(this.opts.onlySelectFromBasicStates)var b=this._configuration.iter();else{var c=new this.opts.Set;this._configuration.iter().forEach(function(a){c.add(a),h.getAncestors(a).forEach(function(a){c.add(a)})},this),b=c.iter()}var d=a&&a.name&&a.name.search("."),e=d?g:this.opts.transitionSelector,f=new this.opts.Set,j=this._evaluateAction.bind(this,a);b.forEach(function(b){e(b,a,j).forEach(function(a){f.add(a)})});var k=this._selectPriorityEnabledTransitions(f);return i&&this.opts.log("priorityEnabledTransitions",k),k},_selectPriorityEnabledTransitions:function(a){var b=new this.opts.Set,c=this._getInconsistentTransitions(a),d=c[0],e=c[1];for(b.union(d),i&&this.opts.log("enabledTransitions",a),i&&this.opts.log("consistentTransitions",d),i&&this.opts.log("inconsistentTransitionsPairs",e),i&&this.opts.log("priorityEnabledTransitions",b);!e.isEmpty();)a=new this.opts.Set(e.iter().map(function(a){return this.opts.priorityComparisonFn(a)},this)),c=this._getInconsistentTransitions(a),d=c[0],e=c[1],b.union(d),i&&this.opts.log("enabledTransitions",a),i&&this.opts.log("consistentTransitions",d),i&&this.opts.log("inconsistentTransitionsPairs",e),i&&this.opts.log("priorityEnabledTransitions",b);return b},_getInconsistentTransitions:function(a){var b=new this.opts.Set,c=new this.opts.Set,d=a.iter();i&&this.opts.log("transitions",d);for(var e=0;e<d.length;e++)for(var f=e+1;f<d.length;f++){var g=d[e],h=d[f];this._conflicts(g,h)&&(b.add(g),b.add(h),c.add([g,h]))}var j=a.difference(b);return[j,c]},_conflicts:function(a,b){return!this._isArenaOrthogonal(a,b)},_isArenaOrthogonal:function(a,b){i&&this.opts.log("transition scopes",a.scope,b.scope);var c=h.isOrthogonalTo(a.scope,b.scope);return i&&this.opts.log("transition scopes are orthogonal?",c),c},registerListener:function(a){return this._listeners.push(a)},unregisterListener:function(a){return this._listeners.splice(this._listeners.indexOf(a),1)}},e.prototype=Object.create(d.prototype),e.prototype.gen=function(a,b){var c;switch(typeof a){case"string":c={name:a,data:b};break;case"object":if("string"!=typeof a.name)throw new Error('Event object must have "name" property of type string.');c=a;break;default:throw new Error("First argument to gen must be a string or object.")}if(this._externalEventQueue.push(c),this._isStepping)return null;this._isStepping=!0;for(var d;d=this._externalEventQueue.shift();)this._performBigStep(d);return this._isStepping=!1,this.getConfiguration()},e.prototype.send=function(a,b,c){var d;switch(typeof a){case"string":d={name:a,data:b},c=c||{};break;case"object":if("string"!=typeof a.name)throw new Error('Event object must have "name" property of type string.');d=a,c=b||{};break;default:throw new Error("First argument to send must be a string or object.")}if(void 0===c.delay)this.gen(d);else{if("undefined"==typeof setTimeout)throw new Error("Default implementation of Statechart.prototype.send will not work unless setTimeout is defined globally.");i&&this.opts.log("sending event",d.name,"with content",d.data,"after delay",c.delay);var e=setTimeout(this.gen.bind(this,d),c.delay||0);c.sendid&&(this._timeoutMap[c.sendid]=e)}},e.prototype.cancel=function(a){if("undefined"==typeof clearTimeout)throw new Error("Default implementation of Statechart.prototype.cancel will not work unless setTimeout is defined globally.");a in this._timeoutMap&&(i&&this.opts.log("cancelling ",a," with timeout id ",this._timeoutMap[a]),clearTimeout(this._timeoutMap[a]))},{BaseInterpreter:d,Statechart:e,ArraySet:b,STATE_TYPES:f,initializeModel:a}}),define("scalejs.statechart-scion/state.builder",["scalejs!core","scion-ng"],function(a,b){"use strict";return function(c){function d(a){return A(function(b){if(b.onEntry)throw new Error("Only one `onEntry` action is allowed.");if("function"!=typeof a)throw new Error("`onEntry` takes a function as a parameter.");return b.onEntry=a,b})}function e(a){return A(function(b){if(b.onExit)throw new Error("Only one `onExit` action is allowed.");if("function"!=typeof a)throw new Error("`onExit` takes a function as a parameter.");return b.onExit=a,b})}function f(a){return A(function(b){b.event=a})}function g(a){return A(function(b){b.cond=a})}function h(a,b,c){return A(function(d){return"state"===d.type||"parallel"===d.type?u(h(a,b,c))(d):(a&&(d.type="internal"),void("function"==typeof b?d.onTransition=b:(d.target=x(b,"array")?b:b.split(" "),c&&(d.onTransition=c))))})}function i(a,b){return h(!1,a,b)}function j(a,b){return h(!0,a,b)}function k(a){if("function"==typeof a)return A(function(b){b.onTransition=a});if("$yield"===a.kind)return a;throw new Error("Unsupported transition action",a)}function l(){var a,b=v.copy(arguments),c=b.pop();if(b.length>2)throw new Error("First (optional) argument should be event name, second (optional) argument should be a condition function");if("function"!=typeof c&&"$yield"!==c.kind)throw new Error("Last argument should be either `goto` or a function.");return a=b.map(function(a){if("string"==typeof a)return f(a);if("function"==typeof a)return g(a);throw new Error("Transition argument ",a," is not supported. First (optional) argument should be event name, second (optional) argument should be a condition function")}),A(u.apply(null,a.concat([k(c)])))}function m(){var a=v.copy(arguments),b=a.pop();if(a.forEach(function(a){if("string"!=typeof a)throw new Error("`whenInStates` accepts list of states and either `goto` or a function as the last argument.")}),"function"!=typeof b&&"$yield"!==b.kind)throw new Error("Last argument should be either `goto` or a function.");return A(u(g(function(b,c){return a.every(function(a){return c(a)})}),b))}function n(){var a=v.copy(arguments),b=a.pop();if(a.forEach(function(a){if("string"!=typeof a)throw new Error("`whenNotInStates` accepts list of states and either `goto` or a function as the last argument.")}),"function"!=typeof b&&"$yield"!==b.kind)throw new Error("Last argument should be either `goto` or a function.");return A(u(g(function(b,c){return a.every(function(a){return!c(a)})}),b))}function o(a){return A(function(b){return b.parallel?new Error("`initial` shouldn't be specified on parallel region."):void(b.initial=a)})}function p(c){return function(){var d,e;return d=s.apply(null,arguments),e=new b.Statechart(d,y({log:a.log.debug},c))}}var q,r,s,t,u,v=a.array,w=a.object.has,x=a.type.is,y=a.object.merge,z=a.functional.builder,A=z.$yield;return q=z({run:function(a,b){var c={};return w(b,"parallel")?c.type="parallel":c.type="state",a(c),c},delay:function(a){return a()},zero:function(){return function(){}},$yield:function(a){return a},combine:function(a,b){return function(c){a(c),b(c)}},missing:function(a){if("string"==typeof a)return function(b){if(b.id)throw new Error("Can't set state id to \""+a+'". state\'s id is already set to "'+b.id+'"');b.id=a};if("function"==typeof a)return a;if("state"===a.type||"parallel"===a.type)return function(b){b.states||(b.states=[]),b.states.push(a)};throw new Error("Missing builder for expression: "+JSON.stringify(a))}}),s=q(),t=q({parallel:!0}),r=z({run:function(a){return function(b){b.transitions||(b.transitions=[]);var c={};a(c),b.transitions.push(c)}},delay:function(a){return a()},zero:function(){return function(){}},$yield:function(a){return a},combine:function(a,b){return function(c){a(c),b(c)}},missing:function(a){if("function"==typeof a)return a;throw new Error('Unknown operation "'+a.kind+'" in transition expression',a)}}),u=r(),{builder:p,state:s,parallel:t,initial:o,onEntry:d,onExit:e,on:l,whenInStates:m,whenNotInStates:n,"goto":i,gotoInternally:j,statechart:p({logStatesEnteredAndExited:c.logStatesEnteredAndExited,log:a.log.debug})}}}),define("scalejs.statechart-scion/state",["scalejs!core","./state.builder","scion-ng","scalejs.functional","scalejs.linq-linqjs"],function(a,b,c){"use strict";return function(d){function e(a){return t(a,"states")?q.make(a).concat(q.from(a.states).selectMany(e)):q.make(a)}function f(a,b){var c=e(a).firstOrDefault(function(a){return a.id===b});return c}function g(a,b){var c=e(a).firstOrDefault(function(a){return a.states&&a.states.some(function(a){return a.id===b})});return c}function h(){return v(function(a,b){var c,d;if(c=f(o,a),!c)throw new Error('Parent state "'+a+"\" doesn't exist");if(t(b,"id")&&(d=f(o,b.id)))throw new Error('State "'+b.id+'" already exists.');t(c,"states")||(c.states=[]),c.states.push(b)}).apply(null,arguments)}function i(b){if(a.isApplicationRunning())throw new Error("Can't register a state while application is running.");r(arguments,1).forEach(h(b))}function j(a,b){var c;if(c=f(o,a),!c)throw new Error('Parent state "'+a+"\" doesn't exist");b.expr(c)}function k(){if(a.isApplicationRunning())throw new Error("Can't unregister a state while application is running.");r(arguments).forEach(function(a){var b=g(o,a),c=q.from(b.states).first(function(b){return b.id===a});s(b.states,c)})}function l(a,b,c){var d;if(u(a,"string"))d={name:a};else{if(!t(a,"name"))throw new Error("event object should have `name` property.");d=a}!t(c)&&u(b,"number")?c=b:d.data=b,p.send(d,{delay:c})}function m(){return a.reactive.Observable.create(function(a){var b={onEntry:function(b,c){a.onNext({event:"entry",state:b,context:this,currentEvent:c})},onExit:function(b,c){a.onNext({event:"exit",state:b,currentEvent:c})},onTransition:function(b,c,d){a.onNext({event:"transition",source:b,targets:c,currentEvent:d})}};return p?p.registerListener(b):z.push(b),function(){p.unregisterListener(b)}})}function n(a){return function(b){m().where(function(b){return"entry"===b.event&&b.state===a}).take(1).subscribe(function(){b()})}}var o,p,q=a.linq.enumerable,r=a.array.toArray,s=a.array.removeOne,t=a.object.has,u=a.type.is,v=a.functional.curry,w=b(d),x=w.state,y=w.parallel,z=[];return o=x("scalejs-app",y("root")),a.onApplicationEvent(function(b){switch(b){case"started":if(o.states[0].states){p=new c.Statechart(o,{logStatesEnteredAndExited:d.logStatesEnteredAndExited,log:a.log.debug}),z.forEach(function(a){p.registerListener(a)}),p.start();break}console.log("Statechart expects at least one state to be defined.");break;case"stopped":}}),{registerStates:i,registerTransition:j,unregisterStates:k,raise:l,observe:m,onState:n,builder:w}}}),define("scalejs.statechart-scion",["scalejs!core","./scalejs.statechart-scion/state","module"],function(a,b,c){"use strict";a.registerExtension({state:b(c.config())})});