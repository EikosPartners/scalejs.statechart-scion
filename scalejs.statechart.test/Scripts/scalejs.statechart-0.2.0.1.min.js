define("scalejs.statechart/stateKinds",{BASIC:0,COMPOSITE:1,PARALLEL:2,HISTORY:3,INITIAL:4,FINAL:5}),define("scalejs.statechart/model",["scalejs!core","./stateKinds"],function(e,t){function r(e,t){var n;return n=e.ancestors.indexOf(t),n>-1?e.ancestors.slice(0,n+1):e.ancestors}function i(e,t){return[e].concat(r(e,t))}function s(e,t){return i(t).indexOf(e)>-1||i(e).indexOf(t)>-1}function o(e,t){var i=n.from(r(e)).firstOrDefault(null,function(e){return e.descendants.indexOf(t)>-1});return i}function u(e,n){return!s(e,n)&&o(e,n).kind===t.PARALLEL}function a(e,t){var n=e.targets?e.lca:e.source,r=t.targets?t.lca:t.source,i=u(n,r);return i}function f(e){var t=e[0],n=e[1];return t.source.depth<n.source.depth?n:n.source.depth<t.source.depth?t:t.documentOrder<n.documentOrder?t:n}var n=e.linq.enumerable;return{getLCA:o,getAncestors:r,getAncestorsOrSelf:i,isArenaOrthogonal:a,getTransitionWithHigherSourceChildPriority:f}}),define("scalejs.statechart/transition",["scalejs!core"],function(e){var t=e.object.has,n=e.linq.enumerable;return function(e,r,i){function s(){var r,s;return t(e,"event")?e.event==="*"?[e.event]:(s=e.event.trim().split(/\s+/),r=n.from(s).select(function(e){return e.indexOf(".*",e.length-2)>=0?e.substring(0,e.length-2):e}).where('$ !== "*"').doAction(function(e){i.uniqueEvents[e]=!0}).toArray(),r):undefined}function o(){return e.condition}function u(){return t(e,"target")?e.target.trim().split(/\s+/):[]}function a(){return e.action}var f={events:s(),condition:o(),source:r.id,targets:u(),action:a(),documentOrder:i.transitions.length,id:i.transitions.length};return i.transitions.push(f),f}}),define("scalejs.statechart/state",["scalejs!core","./stateKinds","./transition"],function(e,t,n){var r=e.object.has,i=e.linq.enumerable,s=e.array;return function o(e,u,a){function l(e){if(u.length===0)return"root";var t=a.uniqueIds[e]||0,n=t+1,r=e+"_"+n;return a.uniqueIds[e]=n,r}function c(){f.parentId=u.length>0?u[u.length-1]:undefined}function h(){if(r(e,"id")){if(a.idToStateMap.hasOwnProperty(e.id))throw{name:"Illegal Argument",message:"Duplicate state id `"+e.id+"`. State id-s must be unique."};f.id=e.id}else f.id=l(e.initial===!0?"initial":"state");a.idToStateMap[f.id]=f}function p(){var n;if(e.parallel){f.kind=t.PARALLEL;return}if(r(e,"states")){f.kind=t.COMPOSITE;return}if(e.history){f.kind=t.HISTORY;return}if(e.initial===!0){n=a.idToStateMap[f.parentId];if(r(n,"initial"))throw new Error('Duplicate initial states in state "'+f.id+'".');n&&(n.initialId=f.id),f.kind=t.INITIAL;return}if(e.final){f.kind=t.FINAL;return}f.kind=t.BASIC}function d(){if(!r(e,"states"))return;var t=u.concat(f.id),n=e.states.map(function(e){var n=o(e,t,a);return n.id});f.childrenIds=n}function v(){if(!r(e,"transitions"))return;var t=i.from(e.transitions).select(function(e){var t=n(e,f,a);return t.id}).toArray();f.transitionIds=t}function m(){a.states.push(f),f.documentOrder=a.states.length-1}function g(){if(f.kind===t.BASIC||f.kind===t.INITIAL||f.kind===t.HISTORY)a.basicStates.push(f),f.basicDocumentOrder=a.basicStates.length-1}function y(){var n,r;if(f.kind===t.PARALLEL||f.childrenIds.length===0)return;r=f.initialId||e.initial||f.childrenIds[0],n=o({initial:!0,transitions:[{target:r}]},u.concat(f.id),a),f.childrenIds.push(n.id),f.initialId=n.id}function b(){u.forEach(function(e){a.idToStateMap[e].descendantIds.push(f.id)})}var f={onEntry:e.onEntry,onExit:e.onExit,depth:u.length,ancestorIds:s.copy(u),descendantIds:[],childrenIds:[],transitionIds:[]};return h(),c(),p(),d(),v(),y(),m(),g(),b(),f}}),define("scalejs.statechart/builder",["scalejs!core"],function(e){function i(e){function i(i){if(n(e,"onEntry"))throw new Error("Only one `onEntry` action is allowed.");if(!t(i,"function"))throw new Error("`onEntry` takes a function as a parameter.");return e.onEntry=i,r}function s(i){if(n(e,"onExit"))throw new Error("Only one `onExit` action is allowed.");if(!t(i,"function"))throw new Error("`onExit` takes a function as a parameter.");return e.onExit=i,r}function o(){var t={};return n(e,"transitions")||(e.transitions=[]),e.transitions.push(t),t}function u(e,i,s){if(!e)throw new Error("`transition` is undefined.");if(t(i,"string")){e.target=i;if(n(s)){if(!t(s,"function"))throw new Error("`action` must be an action.");e.action=s}return r}if(t(i,"function")){if(n(s))throw new Error("`goto` parameters should be either target id(s) or action function or both.");return e.action=i,r}throw new Error("`goto` parameters should be either target id(s) or action function or both.")}function a(e,t){return u(o(),e,t)}function f(e,i){var s=o(),a={doNothing:r,"goto":function(e,t){return u(s,e,t)}};if(t(e,"string")){s.event=e;if(n(i)){if(!t(i,"function"))throw new Error("`condition` must be a function.");s.condition=i}return a}if(t(e,"function")){if(n(i))throw new Error("`on` parameters should be either an event name or condition function or both.");return s.condition=e,a}throw new Error("`on` parameters should be either an event name or condition function or both.")}function l(){return e}var r;return r={isBuilder:!0,onEntry:i,onExit:s,on:f,"goto":a,toSpec:l},r}function s(e,t){var n=1;if(arguments.length>1){if(!t.isBuilder){n=2;if(t.initial){if(e.parallel)return new Error("`initial` shouldn't be specified on parallel region.");e.initial=t.initial}t.parallel&&(e.parallel=t.parallel)}arguments.length>n&&(e.states=r.toArray(arguments).slice(n).map(function(e){return e.toSpec()}))}return i(e)}function o(e){return t(e,"string")?s.apply(null,[{id:e}].concat(r.toArray(arguments,1))):s.apply(null,[{}].concat(r.toArray(arguments)))}function u(e){return t(e,"string")?s.apply(null,[{id:e,parallel:!0}].concat(r.toArray(arguments,1))):s.apply(null,[{parallel:!0}].concat(r.toArray(arguments)))}var t=e.type.is,n=e.object.has,r=e.array;return{state:o,parallel:u}}),define("scalejs.statechart/factory",["scalejs!core","./model","./state","./builder"],function(e,t,n,r){var i=e.object.has;return function(){function a(e){return s.idToStateMap[e]}function f(){s.states.forEach(function(e){e.ancestorIds.reverse(),e.descendantIds.reverse(),e.initial=a(e.initialId),e.history=a(e.history),e.children=e.childrenIds.map(a),e.parent=a(e.parentId),e.ancestors=e.ancestorIds.map(a),e.descendants=e.descendantIds.map(a),e.transitions=e.transitionIds.map(function(e){return s.transitions[e]})})}function l(){s.transitions.forEach(function(e){e.source=a(e.source),e.targets=e.targets.map(function(e){var t=a(e);if(!i(t))throw new Error('Transition targets state "'+e+"\" but such state doesn't exist.");return t}),e.targets.length>0&&(e.lca=t.getLCA(e.source,e.targets[0]))})}function c(e){if(arguments.length===1&&!e.isBuilder)return e;var t=r.state.apply(null,["root"].concat(Array.prototype.slice.call(arguments,0)));return t.toSpec()}function h(){return s={states:[],basicStates:[],uniqueEvents:{},transitions:[],idToStateMap:{},onFoundStateIdCallbacks:[],uniqueIds:{}},o=c.apply(null,arguments),u=n(o,[],s),f(),l(),u}function p(){return u}function d(){return o}function v(){return s.states}function m(){return s.transitions}var s,o,u;return{create:h,getRoot:p,getSpec:d,getStates:v,getTransitions:m}}}),define("scalejs.statechart/eventRaiser",["scalejs!core"],function(e){var t=e.object.has,n=e.object.get,r=e.type.is,i=e.log.debug;return function(s,o){function u(e,t){if(!r(e,"string"))throw{name:"Illegal Argument",message:"`eventName` must be a string."};return{name:e,data:t}}function a(e,r,s,a){var f=u(e,r);n(o,"printTrace")&&i("raising event "+f.name+" with content",f.data,"after delay ",s),t(s)?setTimeout(function(){a(f)},s):a(f)}function f(e,n,i,s){if(r(n,"number")){a(e,{},n,s);return}if(!t(n)||r(n,"object")){a(e,n,i,s);return}throw new Error("`dataOrDelay` must be either a number indicating the delay or an event data object.")}return function(e,t,n){f(e,t,n,s)}}}),define("scalejs.statechart/runtime",["scalejs!core","./eventRaiser"],function(e,t){var n=e.object.has,r=e.object.get,i=e.array,s=e.log.debug,o=e.object.merge,u=e.object.clone;return function(a){function c(e){function r(t){if(!n(e))throw{name:"Illegal Operation",message:"Raising events is not allowed in transition conditions."};i.addOne(e,t)}function s(){var e=Array.prototype.slice.call(arguments,0);return a.getFullConfiguration().some(function(t){return e.some(function(e){return e===t})})}return o(l,{bigstep:u(f),raise:t(r),inState:s})}function h(e,t,n,i,o){r(a,"printTrace")&&s("Running action "+e+"."+t);var u=c(o),f=n.call(u,i);return delete u.raise,delete u.bigstep,l=u,r(a,"printTrace")&&s("Finished action "+e+"."+t),f}function p(e){var t=c();return function(n){if(n.condition)return n.condition.call(t,e)}}function d(){l=u(f)}function v(){f=l}var f={},l={};return{beginSmallStep:d,endSmallStep:v,runAction:h,transitionConditionEvaluator:p}}}),define("scalejs.statechart/transitionSelector",["scalejs!core"],function(e){var t=e.linq.enumerable;return function(){function r(e){return new RegExp("^"+e.replace(/\./g,"\\.")+"(\\.[0-9a-zA-Z]+)*$")}function i(e){return n[e]||(n[e]=r(e)),n[e]}function s(e,n){var r=e.events,s=r.indexOf("*")>-1?function(){return!0}:function(e){return t.from(r).any(function(t){return i(t).test(e)})};return t.from(n).any(s)}var n={};return function(e,t,n){return e.transitions.filter(function(e){return(!e.events||s(e,t))&&(!e.condition||n(e))})}}}),define("scalejs.statechart/statechart",["scalejs!core","./model","./factory","./runtime","./stateKinds","./transitionSelector","./eventRaiser"],function(e,t,n,r,i,s,o){var u=e.log.debug,a=e.array,f=e.linq.enumerable;return function(){function S(e,n){return!t.isArenaOrthogonal(e,n)}function x(e){var t=[],n=[],r,i,s,o,u;for(r=0;r<e.length;r+=1)for(i=r+1;i<e.length;i+=1)s=e[r],o=e[i],S(s,o)&&(a.addOne(t,s),a.addOne(t,o),a.addOne(n,[s,o]));return u=f.from(e).except(t).toArray(),[u,n]}function T(e){var n=[],r=x(e),i=r[0],s=r[1];n=a.copy(i);while(s.length>0)e=f.from(s).select(t.getTransitionWithHigherSourceChildPriority).distinct().toArray(),r=x(e),i=r[0],s=r[1],n=f.from(n).union(i).toArray();return n}function N(e){var n,r,i,s,o;return n=f.from(p).selectMany(function(e){return t.getAncestorsOrSelf(e)}).distinct().toArray(),s=c.transitionConditionEvaluator(e),r=f.from(e).select("$.name").toArray(),i=f.from(n).selectMany(function(e){return h(e,r,s)}).distinct().toArray(),o=T(i),o}function C(e){var n=[],r=[],i=[];return e.forEach(function(e){var i=e.lca,s=i.descendants;p.forEach(function(e){s.indexOf(e)>-1&&(a.addOne(r,e),a.addOne(n,e),t.getAncestors(e,i).forEach(function(e){a.addOne(n,e)}))})}),i=f.from(n).orderBy("$.depth").toArray(),[r,i]}function k(e){var n=[],r=[],s=[],o=[],u,l,c,h;l=function(e,r){u(r);var o=t.getLCA(e,r),f=t.getAncestors(r,o);f.forEach(function(e){e.kind===i.COMPOSITE?(a.addOne(n,e),a.addOne(s,e)):u(e)})},u=function(e){if(s.indexOf(e)>-1)return;e.kind===i.HISTORY?d.hasOwnProperty(e.id)?d[e.id].forEach(function(t){l(e,t)}):(a.addOne(n,e),a.addOne(r,e)):(a.addOne(n,e),e.kind===i.PARALLEL?o.push.apply(o,e.children.filter(function(e){return e.kind!==i.HISTORY})):e.kind===i.COMPOSITE?o.push(e.initial):(e.kind===i.INITIAL||e.kind===i.BASIC||e.kind===i.FINAL)&&a.addOne(r,e)),a.addOne(s,e)},e.forEach(function(e){e.targets.forEach(function(t){l(e.source,t)})});while((c=o.shift())!==undefined)u(c);return h=f.from(n).orderBy("$.depth").toArray(),[r,h]}function L(e){var t,n,r,s,o,a,l,h,m,w;return c.beginSmallStep(),y&&u("selecting transitions with eventSet: ",e),t=N(e),t.length>0&&(y&&u("sorted transitions: ",t),n=f.from(t).where("$.targets").toArray(),r=C(n),s=r[0],o=r[1],a=k(n),l=a[0],h=a[1],y&&(u("basicStatesExited ",s),u("basicStatesEntered ",l),u("statesExited ",o),u("statesEntered ",h)),m=[],y&&u("executing state exit actions"),o.forEach(function(t){(y||b)&&u("exiting ",t.id),g.forEach(function(e){e.onExit&&e.onExit(t.id)}),t.onExit!==undefined&&c.runAction(t.id,"onExit",t.onExit,e,m);var n;t.history&&(t.history.isDeep?n=function(e){return e.kind===i.BASIC&&t.descendants.indexOf(e)>-1}:n=function(e){return e.parent===t},d[t.history.id]=o.filter(n))}),w=f.from(t).orderBy("$.documentOrder").toArray(),y&&u("executing transitition actions"),w.forEach(function(t){var n=f.from(t.targets).select("$.id").toArray();g.forEach(function(e){e.onTransition&&e.onTransition(t.source.id,n)}),t.action&&c.runAction(t.source.id,"action",t.action,e,m)}),y&&u("executing state enter actions"),h.forEach(function(t){(y||b)&&u("entering",t.id),g.forEach(function(e){e.onEntry&&e.onEntry(t.id)}),t.onEntry&&c.runAction(t.id,"onEntry",t.onEntry,e,m)}),y&&(u("updating configuration "),u("old configuration ",p)),p=f.from(p).except(s).union(l).toArray(),y&&u("new configuration ",p),m.length>0&&(y&&u("adding triggered events to inner queue ",m),v.push(m)),y&&u("updating datamodel for next small step :")),c.endSmallStep(),t}function A(e){e&&v.push([e]);var t=!0,n,r;while(t)n=v.length>0?v.shift():[],r=L(n),t=f.from(r).any();m=f.from(p).all(function(e){return e.kind===i.FINAL})}function O(){var e=f.from(p).orderBy("$.documentOrder").select("$.id").toArray();return e}function M(){var e=f.from(p).selectMany(function(e){return t.getAncestorsOrSelf(e)}).select("$.id").orderBy("$.documentOrder").distinct().toArray();return e}function _(e){if(w)throw new Error("`raiseEvent` called before previous call to `raiseEvent` could complete. If executed in single-threaded environment, this means it was called recursively,which is illegal, as it would break SCION step semantics.");w=!0,A(e),w=!1}function D(){return y&&u("performing initial big step"),A(),O()}function P(){return l.getSpec()}var l,c,h,p=[],d,v=[],m=!1,g=[],y=!1,b=!1,w=!1,E;return h=s(),l=n(),E=l.create.apply(null,arguments),p.push(E.initial||E),c=r({printTrace:y,getFullConfiguration:M}),{factory:l,start:D,raise:o(_),getConfiguration:O,getFullConfiguration:M,getSpecification:P}}}),define("scalejs.statechart",["scalejs!core","./scalejs.statechart/statechart","./scalejs.statechart/builder"],function(e,t,n){function f(e,t){function n(e){return i(e,"states")?r.make(e).concat(r.from(e.states).selectMany(function(e){return n(e)})):r.make(e)}var s=n(e).firstOrDefault(function(e){return e.id===t});return s}function l(t,n){if(e.isApplicationStarted())throw new Error("Can't add new state to application that is already running.");var r=n.toSpec(),s,o;s=f(u,t);if(!s)throw new Error('Parent state "'+t+"\" doesn't exist");if(i(r,"id")){o=f(u,r.id);if(o)throw new Error('State "'+r.id+'" already exists.')}i(s,"states")||(s.states=[]),s.states.push(r)}function c(e,t,n){a.raise(e,t,n)}var r=e.linq.enumerable,i=e.object.has,s=n.state,o=n.parallel,u,a;u=s("scalejs",o("root")).toSpec(),e.onApplicationStarted(function(){a=t(u),a.start()}),e.registerExtension({state:{registerState:l,raise:c,statechart:t,builder:n}})});