/*--------------------------------------------------------------------------
 * linq.js - LINQ for JavaScript
 * ver 3.0.2-RC (Sep. 16th, 2012)
 *
 * created and maintained by neuecc <ils@neue.cc>
 * licensed under MIT License
 * http://linqjs.codeplex.com/
 *------------------------------------------------------------------------*/

(function(e,t){var n="enumerator is disposed",r="single:sequence contains more than one element.",i=!1,s=null,o=!0,u={Identity:function(e){return e},True:function(){return o},Blank:function(){}},a={Boolean:typeof o,Number:"number",String:"string",Object:typeof {},Undefined:typeof t,Function:typeof function(){}},f={createLambda:function(e){if(e==s)return u.Identity;if(typeof e==a.String){if(e=="")return u.Identity;if(e.indexOf("=>")==-1){var t=new RegExp("[$]+","g"),n=0,r;while(r=t.exec(e)){var i=r[0].length;i>n&&(n=i)}for(var o=[],f=1;f<=n;f++){for(var l="",c=0;c<f;c++)l+="$";o.push(l)}var h=Array.prototype.join.call(o,",");return new Function(h,"return "+e)}var p=e.match(/^[(\s]*([^()]*?)[)\s]*=>(.*)/);return new Function(p[1],"return "+p[2])}return e},isIEnumerable:function(e){if(typeof Enumerator!==a.Undefined)try{return new Enumerator(e),o}catch(t){}return i},defineProperty:Object.defineProperties!=s?function(e,t,n){Object.defineProperty(e,t,{enumerable:i,configurable:o,writable:o,value:n})}:function(e,t,n){e[t]=n},compare:function(e,t){return e===t?0:e>t?1:-1},dispose:function(e){e!=s&&e.dispose()}},l={Before:0,Running:1,After:2},c=function(e,t,n){var r=new h,s=l.Before;this.current=r.current,this.moveNext=function(){try{switch(s){case l.Before:s=l.Running,e();case l.Running:return t.apply(r)?o:(this.dispose(),i);case l.After:return i}}catch(n){throw this.dispose(),n}},this.dispose=function(){if(s!=l.Running)return;try{n()}finally{s=l.After}}},h=function(){var e=s;this.current=function(){return e},this.yieldReturn=function(t){return e=t,o},this.yieldBreak=function(){return i}},p=function(e){this.getEnumerator=e};p.Utils={},p.Utils.createLambda=function(e){return f.createLambda(e)},p.Utils.createEnumerable=function(e){return new p(e)},p.Utils.createEnumerator=function(e,t,n){return new c(e,t,n)},p.Utils.extendTo=function(e){var t=e.prototype,n;e===Array?(n=g.prototype,f.defineProperty(t,"getSource",function(){return this})):(n=p.prototype,f.defineProperty(t,"getEnumerator",function(){return p.from(this).getEnumerator()}));for(var r in n){var i=n[r];if(t[r]==i)continue;if(t[r]!=s){r+="ByLinq";if(t[r]==i)continue}i instanceof Function&&f.defineProperty(t,r,i)}},p.choice=function(){var e=arguments;return new p(function(){return new c(function(){e=e[0]instanceof Array?e[0]:e[0].getEnumerator!=s?e[0].toArray():e},function(){return this.yieldReturn(e[Math.floor(Math.random()*e.length)])},u.Blank)})},p.cycle=function(){var e=arguments;return new p(function(){var t=0;return new c(function(){e=e[0]instanceof Array?e[0]:e[0].getEnumerator!=s?e[0].toArray():e},function(){return t>=e.length&&(t=0),this.yieldReturn(e[t++])},u.Blank)})},p.empty=function(){return new p(function(){return new c(u.Blank,function(){return i},u.Blank)})},p.from=function(e){if(e==s)return p.empty();if(e instanceof p)return e;if(typeof e==a.Number||typeof e==a.Boolean)return p.repeat(e,1);if(typeof e==a.String)return new p(function(){var t=0;return new c(u.Blank,function(){return t<e.length?this.yieldReturn(e.charAt(t++)):i},u.Blank)});if(typeof e!=a.Function){if(typeof e.length==a.Number)return new g(e);if(!(e instanceof Object||!f.isIEnumerable(e)))return new p(function(){var t=o,n;return new c(function(){n=new Enumerator(e)},function(){return t?t=i:n.moveNext(),n.atEnd()?i:this.yieldReturn(n.item())},u.Blank)});if(typeof Windows===a.Object&&typeof e.first===a.Function)return new p(function(){var t=o,n;return new c(function(){n=e.first()},function(){return t?t=i:n.moveNext(),n.hasCurrent?this.yieldReturn(n.current):this.yieldBreak()},u.Blank)})}return new p(function(){var t=[],n=0;return new c(function(){for(var n in e){var r=e[n];!(r instanceof Function)&&Object.prototype.hasOwnProperty.call(e,n)&&t.push({key:n,value:r})}},function(){return n<t.length?this.yieldReturn(t[n++]):i},u.Blank)})},p.make=function(e){return p.repeat(e,1)},p.matches=function(e,t,n){return n==s&&(n=""),t instanceof RegExp&&(n+=t.ignoreCase?"i":"",n+=t.multiline?"m":"",t=t.source),n.indexOf("g")===-1&&(n+="g"),new p(function(){var r;return new c(function(){r=new RegExp(t,n)},function(){var t=r.exec(e);return t?this.yieldReturn(t):i},u.Blank)})},p.range=function(e,t,n){return n==s&&(n=1),new p(function(){var r,i=0;return new c(function(){r=e-n},function(){return i++<t?this.yieldReturn(r+=n):this.yieldBreak()},u.Blank)})},p.rangeDown=function(e,t,n){return n==s&&(n=1),new p(function(){var r,i=0;return new c(function(){r=e+n},function(){return i++<t?this.yieldReturn(r-=n):this.yieldBreak()},u.Blank)})},p.rangeTo=function(e,t,n){return n==s&&(n=1),e<t?new p(function(){var r;return new c(function(){r=e-n},function(){var e=r+=n;return e<=t?this.yieldReturn(e):this.yieldBreak()},u.Blank)}):new p(function(){var r;return new c(function(){r=e+n},function(){var e=r-=n;return e>=t?this.yieldReturn(e):this.yieldBreak()},u.Blank)})},p.repeat=function(e,t){return t!=s?p.repeat(e).take(t):new p(function(){return new c(u.Blank,function(){return this.yieldReturn(e)},u.Blank)})},p.repeatWithFinalize=function(e,t){return e=f.createLambda(e),t=f.createLambda(t),new p(function(){var n;return new c(function(){n=e()},function(){return this.yieldReturn(n)},function(){n!=s&&(t(n),n=s)})})},p.generate=function(e,t){return t!=s?p.generate(e).take(t):(e=f.createLambda(e),new p(function(){return new c(u.Blank,function(){return this.yieldReturn(e())},u.Blank)}))},p.toInfinity=function(e,t){return e==s&&(e=0),t==s&&(t=1),new p(function(){var n;return new c(function(){n=e-t},function(){return this.yieldReturn(n+=t)},u.Blank)})},p.toNegativeInfinity=function(e,t){return e==s&&(e=0),t==s&&(t=1),new p(function(){var n;return new c(function(){n=e+t},function(){return this.yieldReturn(n-=t)},u.Blank)})},p.unfold=function(e,t){return t=f.createLambda(t),new p(function(){var n=o,r;return new c(u.Blank,function(){return n?(n=i,r=e,this.yieldReturn(r)):(r=t(r),this.yieldReturn(r))},u.Blank)})},p.defer=function(e){return new p(function(){var t;return new c(function(){t=p.from(e()).getEnumerator()},function(){return t.moveNext()?this.yieldReturn(t.current()):this.yieldBreak()},function(){f.dispose(t)})})},p.prototype.traverseBreadthFirst=function(e,t){var n=this;return e=f.createLambda(e),t=f.createLambda(t),new p(function(){var r,s=0,u=[];return new c(function(){r=n.getEnumerator()},function(){while(o){if(r.moveNext())return u.push(r.current()),this.yieldReturn(t(r.current(),s));var n=p.from(u).selectMany(function(t){return e(t)});if(!n.any())return i;s++,u=[],f.dispose(r),r=n.getEnumerator()}},function(){f.dispose(r)})})},p.prototype.traverseDepthFirst=function(e,t){var n=this;return e=f.createLambda(e),t=f.createLambda(t),new p(function(){var r=[],s;return new c(function(){s=n.getEnumerator()},function(){while(o){if(s.moveNext()){var n=t(s.current(),r.length);return r.push(s),s=p.from(e(s.current())).getEnumerator(),this.yieldReturn(n)}if(r.length<=0)return i;f.dispose(s),s=r.pop()}},function(){try{f.dispose(s)}finally{p.from(r).forEach(function(e){e.dispose()})}})})},p.prototype.flatten=function(){var e=this;return new p(function(){var t,n=s;return new c(function(){t=e.getEnumerator()},function(){while(o){if(n!=s){if(n.moveNext())return this.yieldReturn(n.current());n=s}if(t.moveNext()){if(t.current()instanceof Array){f.dispose(n),n=p.from(t.current()).selectMany(u.Identity).flatten().getEnumerator();continue}return this.yieldReturn(t.current())}return i}},function(){try{f.dispose(t)}finally{f.dispose(n)}})})},p.prototype.pairwise=function(e){var t=this;return e=f.createLambda(e),new p(function(){var n;return new c(function(){n=t.getEnumerator(),n.moveNext()},function(){var t=n.current();return n.moveNext()?this.yieldReturn(e(t,n.current())):i},function(){f.dispose(n)})})},p.prototype.scan=function(e,t){var n;t==s?(t=f.createLambda(e),n=i):(t=f.createLambda(t),n=o);var r=this;return new p(function(){var s,u,a=o;return new c(function(){s=r.getEnumerator()},function(){if(a){a=i;if(!!n)return this.yieldReturn(u=e);if(s.moveNext())return this.yieldReturn(u=s.current())}return s.moveNext()?this.yieldReturn(u=t(u,s.current())):i},function(){f.dispose(s)})})},p.prototype.select=function(e){e=f.createLambda(e);if(e.length<=1)return new b(this,s,e);var t=this;return new p(function(){var n,r=0;return new c(function(){n=t.getEnumerator()},function(){return n.moveNext()?this.yieldReturn(e(n.current(),r++)):i},function(){f.dispose(n)})})},p.prototype.selectMany=function(e,n){var r=this;return e=f.createLambda(e),n==s&&(n=function(e,t){return t}),n=f.createLambda(n),new p(function(){var o,u=t,a=0;return new c(function(){o=r.getEnumerator()},function(){if(u===t&&!o.moveNext())return i;do{if(u==s){var r=e(o.current(),a++);u=p.from(r).getEnumerator()}if(u.moveNext())return this.yieldReturn(n(o.current(),u.current()));f.dispose(u),u=s}while(o.moveNext());return i},function(){try{f.dispose(o)}finally{f.dispose(u)}})})},p.prototype.where=function(e){e=f.createLambda(e);if(e.length<=1)return new y(this,e);var t=this;return new p(function(){var n,r=0;return new c(function(){n=t.getEnumerator()},function(){while(n.moveNext())if(e(n.current(),r++))return this.yieldReturn(n.current());return i},function(){f.dispose(n)})})},p.prototype.choose=function(e){e=f.createLambda(e);var t=this;return new p(function(){var n,r=0;return new c(function(){n=t.getEnumerator()},function(){while(n.moveNext()){var t=e(n.current(),r++);if(t!=s)return this.yieldReturn(t)}return this.yieldBreak()},function(){f.dispose(n)})})},p.prototype.ofType=function(e){var t;switch(e){case Number:t=a.Number;break;case String:t=a.String;break;case Boolean:t=a.Boolean;break;case Function:t=a.Function;break;default:t=s}return t===s?this.where(function(t){return t instanceof e}):this.where(function(e){return typeof e===t})},p.prototype.zip=function(){var e=arguments,t=f.createLambda(arguments[arguments.length-1]),n=this;if(arguments.length==2){var r=arguments[0];return new p(function(){var e,s,o=0;return new c(function(){e=n.getEnumerator(),s=p.from(r).getEnumerator()},function(){return e.moveNext()&&s.moveNext()?this.yieldReturn(t(e.current(),s.current(),o++)):i},function(){try{f.dispose(e)}finally{f.dispose(s)}})})}return new p(function(){var r,i=0;return new c(function(){var t=p.make(n).concat(p.from(e).takeExceptLast().select(p.from)).select(function(e){return e.getEnumerator()}).toArray();r=p.from(t)},function(){if(r.all(function(e){return e.moveNext()})){var e=r.select(function(e){return e.current()}).toArray();return e.push(i++),this.yieldReturn(t.apply(s,e))}return this.yieldBreak()},function(){p.from(r).forEach(f.dispose)})})},p.prototype.merge=function(){var e=arguments,t=this;return new p(function(){var n,r=-1;return new c(function(){n=p.make(t).concat(p.from(e).select(p.from)).select(function(e){return e.getEnumerator()}).toArray()},function(){while(n.length>0){r=r>=n.length-1?0:r+1;var e=n[r];if(e.moveNext())return this.yieldReturn(e.current());e.dispose(),n.splice(r--,1)}return this.yieldBreak()},function(){p.from(n).forEach(f.dispose)})})},p.prototype.join=function(e,n,r,a,l){n=f.createLambda(n),r=f.createLambda(r),a=f.createLambda(a),l=f.createLambda(l);var h=this;return new p(function(){var d,v,m=s,g=0;return new c(function(){d=h.getEnumerator(),v=p.from(e).toLookup(r,u.Identity,l)},function(){while(o){if(m!=s){var e=m[g++];if(e!==t)return this.yieldReturn(a(d.current(),e));e=s,g=0}if(!d.moveNext())return i;var r=n(d.current());m=v.get(r).toArray()}},function(){f.dispose(d)})})},p.prototype.groupJoin=function(e,t,n,r,o){t=f.createLambda(t),n=f.createLambda(n),r=f.createLambda(r),o=f.createLambda(o);var a=this;return new p(function(){var l=a.getEnumerator(),h=s;return new c(function(){l=a.getEnumerator(),h=p.from(e).toLookup(n,u.Identity,o)},function(){if(l.moveNext()){var e=h.get(t(l.current()));return this.yieldReturn(r(l.current(),e))}return i},function(){f.dispose(l)})})},p.prototype.all=function(e){e=f.createLambda(e);var t=o;return this.forEach(function(n){if(!e(n))return t=i,i}),t},p.prototype.any=function(e){e=f.createLambda(e);var t=this.getEnumerator();try{if(arguments.length==0)return t.moveNext();while(t.moveNext())if(e(t.current()))return o;return i}finally{f.dispose(t)}},p.prototype.isEmpty=function(){return!this.any()},p.prototype.concat=function(){var e=this;if(arguments.length==1){var t=arguments[0];return new p(function(){var n,r;return new c(function(){n=e.getEnumerator()},function(){if(r==s){if(n.moveNext())return this.yieldReturn(n.current());r=p.from(t).getEnumerator()}return r.moveNext()?this.yieldReturn(r.current()):i},function(){try{f.dispose(n)}finally{f.dispose(r)}})})}var n=arguments;return new p(function(){var t;return new c(function(){t=p.make(e).concat(p.from(n).select(p.from)).select(function(e){return e.getEnumerator()}).toArray()},function(){while(t.length>0){var e=t[0];if(e.moveNext())return this.yieldReturn(e.current());e.dispose(),t.splice(0,1)}return this.yieldBreak()},function(){p.from(t).forEach(f.dispose)})})},p.prototype.insert=function(e,t){var n=this;return new p(function(){var r,s,u=0,a=i;return new c(function(){r=n.getEnumerator(),s=p.from(t).getEnumerator()},function(){return u==e&&s.moveNext()?(a=o,this.yieldReturn(s.current())):r.moveNext()?(u++,this.yieldReturn(r.current())):!a&&s.moveNext()?this.yieldReturn(s.current()):i},function(){try{f.dispose(r)}finally{f.dispose(s)}})})},p.prototype.alternate=function(e){var t=this;return new p(function(){var n,r,i,u;return new c(function(){e instanceof Array||e.getEnumerator!=s?i=p.from(p.from(e).toArray()):i=p.make(e),r=t.getEnumerator(),r.moveNext()&&(n=r.current())},function(){while(o){if(u!=s){if(u.moveNext())return this.yieldReturn(u.current());u=s}if(n==s&&r.moveNext()){n=r.current(),u=i.getEnumerator();continue}if(n!=s){var e=n;return n=s,this.yieldReturn(e)}return this.yieldBreak()}},function(){try{f.dispose(r)}finally{f.dispose(u)}})})},p.prototype.contains=function(e,t){t=f.createLambda(t);var n=this.getEnumerator();try{while(n.moveNext())if(t(n.current())===e)return o;return i}finally{f.dispose(n)}},p.prototype.defaultIfEmpty=function(e){var n=this;return e===t&&(e=s),new p(function(){var t,r=o;return new c(function(){t=n.getEnumerator()},function(){return t.moveNext()?(r=i,this.yieldReturn(t.current())):r?(r=i,this.yieldReturn(e)):i},function(){f.dispose(t)})})},p.prototype.distinct=function(e){return this.except(p.empty(),e)},p.prototype.distinctUntilChanged=function(e){e=f.createLambda(e);var t=this;return new p(function(){var n,r,s;return new c(function(){n=t.getEnumerator()},function(){while(n.moveNext()){var t=e(n.current());if(s)return s=i,r=t,this.yieldReturn(n.current());if(r===t)continue;return r=t,this.yieldReturn(n.current())}return this.yieldBreak()},function(){f.dispose(n)})})},p.prototype.except=function(e,t){t=f.createLambda(t);var n=this;return new p(function(){var r,s;return new c(function(){r=n.getEnumerator(),s=new w(t),p.from(e).forEach(function(e){s.add(e)})},function(){while(r.moveNext()){var e=r.current();if(!s.contains(e))return s.add(e),this.yieldReturn(e)}return i},function(){f.dispose(r)})})},p.prototype.intersect=function(e,t){t=f.createLambda(t);var n=this;return new p(function(){var r,s,o;return new c(function(){r=n.getEnumerator(),s=new w(t),p.from(e).forEach(function(e){s.add(e)}),o=new w(t)},function(){while(r.moveNext()){var e=r.current();if(!o.contains(e)&&s.contains(e))return o.add(e),this.yieldReturn(e)}return i},function(){f.dispose(r)})})},p.prototype.sequenceEqual=function(e,t){t=f.createLambda(t);var n=this.getEnumerator();try{var r=p.from(e).getEnumerator();try{while(n.moveNext())if(!r.moveNext()||t(n.current())!==t(r.current()))return i;return r.moveNext()?i:o}finally{f.dispose(r)}}finally{f.dispose(n)}},p.prototype.union=function(e,n){n=f.createLambda(n);var r=this;return new p(function(){var s,o,u;return new c(function(){s=r.getEnumerator(),u=new w(n)},function(){var n;if(o===t){while(s.moveNext()){n=s.current();if(!u.contains(n))return u.add(n),this.yieldReturn(n)}o=p.from(e).getEnumerator()}while(o.moveNext()){n=o.current();if(!u.contains(n))return u.add(n),this.yieldReturn(n)}return i},function(){try{f.dispose(s)}finally{f.dispose(o)}})})},p.prototype.orderBy=function(e){return new d(this,e,i)},p.prototype.orderByDescending=function(e){return new d(this,e,o)},p.prototype.reverse=function(){var e=this;return new p(function(){var t,n;return new c(function(){t=e.toArray(),n=t.length},function(){return n>0?this.yieldReturn(t[--n]):i},u.Blank)})},p.prototype.shuffle=function(){var e=this;return new p(function(){var t;return new c(function(){t=e.toArray()},function(){if(t.length>0){var e=Math.floor(Math.random()*t.length);return this.yieldReturn(t.splice(e,1)[0])}return i},u.Blank)})},p.prototype.weightedSample=function(e){e=f.createLambda(e);var t=this;return new p(function(){var n,r=0;return new c(function(){n=t.choose(function(t){var n=e(t);return n<=0?s:(r+=n,{value:t,bound:r})}).toArray()},function(){if(n.length>0){var e=Math.floor(Math.random()*r)+1,t=-1,i=n.length;while(i-t>1){var s=Math.floor((t+i)/2);n[s].bound>=e?i=s:t=s}return this.yieldReturn(n[i].value)}return this.yieldBreak()},u.Blank)})},p.prototype.groupBy=function(e,t,n,r){var o=this;return e=f.createLambda(e),t=f.createLambda(t),n!=s&&(n=f.createLambda(n)),r=f.createLambda(r),new p(function(){var u;return new c(function(){u=o.toLookup(e,t,r).toEnumerable().getEnumerator()},function(){while(u.moveNext())return n==s?this.yieldReturn(u.current()):this.yieldReturn(n(u.current().key(),u.current()));return i},function(){f.dispose(u)})})},p.prototype.partitionBy=function(e,t,n,r){var u=this;e=f.createLambda(e),t=f.createLambda(t),r=f.createLambda(r);var a;return n==s?(a=i,n=function(e,t){return new S(e,t)}):(a=o,n=f.createLambda(n)),new p(function(){var s,l,h,d=[];return new c(function(){s=u.getEnumerator(),s.moveNext()&&(l=e(s.current()),h=r(l),d.push(t(s.current())))},function(){var u;while((u=s.moveNext())==o){if(h!==r(e(s.current())))break;d.push(t(s.current()))}if(d.length>0){var f=a?n(l,p.from(d)):n(l,d);return u?(l=e(s.current()),h=r(l),d=[t(s.current())]):d=[],this.yieldReturn(f)}return i},function(){f.dispose(s)})})},p.prototype.buffer=function(e){var t=this;return new p(function(){var n;return new c(function(){n=t.getEnumerator()},function(){var t=[],r=0;while(n.moveNext()){t.push(n.current());if(++r>=e)return this.yieldReturn(t)}return t.length>0?this.yieldReturn(t):i},function(){f.dispose(n)})})},p.prototype.aggregate=function(e,t,n){return n=f.createLambda(n),n(this.scan(e,t,n).last())},p.prototype.average=function(e){e=f.createLambda(e);var t=0,n=0;return this.forEach(function(r){t+=e(r),++n}),t/n},p.prototype.count=function(e){e=e==s?u.True:f.createLambda(e);var t=0;return this.forEach(function(n,r){e(n,r)&&++t}),t},p.prototype.max=function(e){return e==s&&(e=u.Identity),this.select(e).aggregate(function(e,t){return e>t?e:t})},p.prototype.min=function(e){return e==s&&(e=u.Identity),this.select(e).aggregate(function(e,t){return e<t?e:t})},p.prototype.maxBy=function(e){return e=f.createLambda(e),this.aggregate(function(t,n){return e(t)>e(n)?t:n})},p.prototype.minBy=function(e){return e=f.createLambda(e),this.aggregate(function(t,n){return e(t)<e(n)?t:n})},p.prototype.sum=function(e){return e==s&&(e=u.Identity),this.select(e).aggregate(0,function(e,t){return e+t})},p.prototype.elementAt=function(e){var t,n=i;this.forEach(function(r,s){if(s==e)return t=r,n=o,i});if(!n)throw new Error("index is less than 0 or greater than or equal to the number of elements in source.");return t},p.prototype.elementAtOrDefault=function(e,n){n===t&&(n=s);var r,u=i;return this.forEach(function(t,n){if(n==e)return r=t,u=o,i}),u?r:n},p.prototype.first=function(e){if(e!=s)return this.where(e).first();var t,n=i;this.forEach(function(e){return t=e,n=o,i});if(!n)throw new Error("first:No element satisfies the condition.");return t},p.prototype.firstOrDefault=function(e,n){n===t&&(n=s);if(e!=s)return this.where(e).firstOrDefault(s,n);var r,u=i;return this.forEach(function(e){return r=e,u=o,i}),u?r:n},p.prototype.last=function(e){if(e!=s)return this.where(e).last();var t,n=i;this.forEach(function(e){n=o,t=e});if(!n)throw new Error("last:No element satisfies the condition.");return t},p.prototype.lastOrDefault=function(e,n){n===t&&(n=s);if(e!=s)return this.where(e).lastOrDefault(s,n);var r,u=i;return this.forEach(function(e){u=o,r=e}),u?r:n},p.prototype.single=function(e){if(e!=s)return this.where(e).single();var t,n=i;this.forEach(function(e){if(!!n)throw new Error(r);n=o,t=e});if(!n)throw new Error("single:No element satisfies the condition.");return t},p.prototype.singleOrDefault=function(e,n){n===t&&(n=s);if(e!=s)return this.where(e).singleOrDefault(s,n);var u,a=i;return this.forEach(function(e){if(!!a)throw new Error(r);a=o,u=e}),a?u:n},p.prototype.skip=function(e){var t=this;return new p(function(){var n,r=0;return new c(function(){n=t.getEnumerator();while(r++<e&&n.moveNext());},function(){return n.moveNext()?this.yieldReturn(n.current()):i},function(){f.dispose(n)})})},p.prototype.skipWhile=function(e){e=f.createLambda(e);var t=this;return new p(function(){var n,r=0,s=i;return new c(function(){n=t.getEnumerator()},function(){while(!s){if(n.moveNext()){if(!e(n.current(),r++))return s=o,this.yieldReturn(n.current());continue}return i}return n.moveNext()?this.yieldReturn(n.current()):i},function(){f.dispose(n)})})},p.prototype.take=function(e){var t=this;return new p(function(){var n,r=0;return new c(function(){n=t.getEnumerator()},function(){return r++<e&&n.moveNext()?this.yieldReturn(n.current()):i},function(){f.dispose(n)})})},p.prototype.takeWhile=function(e){e=f.createLambda(e);var t=this;return new p(function(){var n,r=0;return new c(function(){n=t.getEnumerator()},function(){return n.moveNext()&&e(n.current(),r++)?this.yieldReturn(n.current()):i},function(){f.dispose(n)})})},p.prototype.takeExceptLast=function(e){e==s&&(e=1);var t=this;return new p(function(){if(e<=0)return t.getEnumerator();var n,r=[];return new c(function(){n=t.getEnumerator()},function(){while(n.moveNext()){if(r.length==e)return r.push(n.current()),this.yieldReturn(r.shift());r.push(n.current())}return i},function(){f.dispose(n)})})},p.prototype.takeFromLast=function(e){if(e<=0||e==s)return p.empty();var t=this;return new p(function(){var n,r,o=[];return new c(function(){n=t.getEnumerator()},function(){while(n.moveNext())o.length==e&&o.shift(),o.push(n.current());return r==s&&(r=p.from(o).getEnumerator()),r.moveNext()?this.yieldReturn(r.current()):i},function(){f.dispose(r)})})},p.prototype.indexOf=function(e){var t=s;return typeof e===a.Function?this.forEach(function(n,r){if(e(n,r))return t=r,i}):this.forEach(function(n,r){if(n===e)return t=r,i}),t!==s?t:-1},p.prototype.lastIndexOf=function(e){var t=-1;return typeof e===a.Function?this.forEach(function(n,r){e(n,r)&&(t=r)}):this.forEach(function(n,r){n===e&&(t=r)}),t},p.prototype.asEnumerable=function(){return p.from(this)},p.prototype.toArray=function(){var e=[];return this.forEach(function(t){e.push(t)}),e},p.prototype.toLookup=function(e,n,r){e=f.createLambda(e),n=f.createLambda(n),r=f.createLambda(r);var i=new w(r);return this.forEach(function(r){var s=e(r),o=n(r),u=i.get(s);u!==t?u.push(o):i.add(s,[o])}),new E(i)},p.prototype.toObject=function(e,t){e=f.createLambda(e),t=f.createLambda(t);var n={};return this.forEach(function(r){n[e(r)]=t(r)}),n},p.prototype.toDictionary=function(e,t,n){e=f.createLambda(e),t=f.createLambda(t),n=f.createLambda(n);var r=new w(n);return this.forEach(function(n){r.add(e(n),t(n))}),r},p.prototype.toJSONString=function(e,t){if(typeof JSON===a.Undefined||JSON.stringify==s)throw new Error("toJSONString can't find JSON.stringify. This works native JSON support Browser or include json2.js");return JSON.stringify(this.toArray(),e,t)},p.prototype.toJoinedString=function(e,t){return e==s&&(e=""),t==s&&(t=u.Identity),this.select(t).toArray().join(e)},p.prototype.doAction=function(e){var t=this;return e=f.createLambda(e),new p(function(){var n,r=0;return new c(function(){n=t.getEnumerator()},function(){return n.moveNext()?(e(n.current(),r++),this.yieldReturn(n.current())):i},function(){f.dispose(n)})})},p.prototype.forEach=function(e){e=f.createLambda(e);var t=0,n=this.getEnumerator();try{while(n.moveNext())if(e(n.current(),t++)===i)break}finally{f.dispose(n)}},p.prototype.write=function(e,t){e==s&&(e=""),t=f.createLambda(t);var n=o;this.forEach(function(r){n?n=i:document.write(e),document.write(t(r))})},p.prototype.writeLine=function(e){e=f.createLambda(e),this.forEach(function(t){document.writeln(e(t)+"<br />")})},p.prototype.force=function(){var e=this.getEnumerator();try{while(e.moveNext());}finally{f.dispose(e)}},p.prototype.letBind=function(e){e=f.createLambda(e);var t=this;return new p(function(){var n;return new c(function(){n=p.from(e(t)).getEnumerator()},function(){return n.moveNext()?this.yieldReturn(n.current()):i},function(){f.dispose(n)})})},p.prototype.share=function(){var e=this,t,r=i;return new m(function(){return new c(function(){t==s&&(t=e.getEnumerator())},function(){if(r)throw new Error(n);return t.moveNext()?this.yieldReturn(t.current()):i},u.Blank)},function(){r=o,f.dispose(t)})},p.prototype.memoize=function(){var e=this,t,r,a=i;return new m(function(){var o=-1;return new c(function(){r==s&&(r=e.getEnumerator(),t=[])},function(){if(a)throw new Error(n);return o++,t.length<=o?r.moveNext()?this.yieldReturn(t[o]=r.current()):i:this.yieldReturn(t[o])},u.Blank)},function(){a=o,f.dispose(r),t=s})},p.prototype.catchError=function(e){e=f.createLambda(e);var t=this;return new p(function(){var n;return new c(function(){n=t.getEnumerator()},function(){try{return n.moveNext()?this.yieldReturn(n.current()):i}catch(t){return e(t),i}},function(){f.dispose(n)})})},p.prototype.finallyAction=function(e){e=f.createLambda(e);var t=this;return new p(function(){var n;return new c(function(){n=t.getEnumerator()},function(){return n.moveNext()?this.yieldReturn(n.current()):i},function(){try{f.dispose(n)}finally{e()}})})},p.prototype.log=function(e){return e=f.createLambda(e),this.doAction(function(t){typeof console!==a.Undefined&&console.log(e(t))})},p.prototype.trace=function(e,t){return e==s&&(e="Trace"),t=f.createLambda(t),this.doAction(function(n){typeof console!==a.Undefined&&console.log(e,t(n))})};var d=function(e,t,n,r){var i=this;i.source=e,i.keySelector=f.createLambda(t),i.descending=n,i.parent=r};d.prototype=new p,d.prototype.createOrderedEnumerable=function(e,t){return new d(this.source,e,t,this)},d.prototype.thenBy=function(e){return this.createOrderedEnumerable(e,i)},d.prototype.thenByDescending=function(e){return this.createOrderedEnumerable(e,o)},d.prototype.getEnumerator=function(){var e=this,t,n,r=0;return new c(function(){t=[],n=[],e.source.forEach(function(e,r){t.push(e),n.push(r)});var r=v.create(e,s);r.GenerateKeys(t),n.sort(function(e,t){return r.compare(e,t)})},function(){return r<n.length?this.yieldReturn(t[n[r++]]):i},u.Blank)};var v=function(e,t,n){var r=this;r.keySelector=e,r.descending=t,r.child=n,r.keys=s};v.create=function(e,t){var n=new v(e.keySelector,e.descending,t);return e.parent!=s?v.create(e.parent,n):n},v.prototype.GenerateKeys=function(e){var t=this;for(var n=e.length,r=t.keySelector,i=new Array(n),o=0;o<n;o++)i[o]=r(e[o]);t.keys=i,t.child!=s&&t.child.GenerateKeys(e)},v.prototype.compare=function(e,t){var n=this,r=f.compare(n.keys[e],n.keys[t]);return r==0?n.child!=s?n.child.compare(e,t):f.compare(e,t):n.descending?-r:r};var m=function(e,t){this.dispose=t,p.call(this,e)};m.prototype=new p;var g=function(e){this.getSource=function(){return e}};g.prototype=new p,g.prototype.any=function(e){return e==s?this.getSource().length>0:p.prototype.any.apply(this,arguments)},g.prototype.count=function(e){return e==s?this.getSource().length:p.prototype.count.apply(this,arguments)},g.prototype.elementAt=function(e){var t=this.getSource();return 0<=e&&e<t.length?t[e]:p.prototype.elementAt.apply(this,arguments)},g.prototype.elementAtOrDefault=function(e,n){n===t&&(n=s);var r=this.getSource();return 0<=e&&e<r.length?r[e]:n},g.prototype.first=function(e){var t=this.getSource();return e==s&&t.length>0?t[0]:p.prototype.first.apply(this,arguments)},g.prototype.firstOrDefault=function(e,n){n===t&&(n=s);if(e!=s)return p.prototype.firstOrDefault.apply(this,arguments);var r=this.getSource();return r.length>0?r[0]:n},g.prototype.last=function(e){var t=this.getSource();return e==s&&t.length>0?t[t.length-1]:p.prototype.last.apply(this,arguments)},g.prototype.lastOrDefault=function(e,n){n===t&&(n=s);if(e!=s)return p.prototype.lastOrDefault.apply(this,arguments);var r=this.getSource();return r.length>0?r[r.length-1]:n},g.prototype.skip=function(e){var t=this.getSource();return new p(function(){var n;return new c(function(){n=e<0?0:e},function(){return n<t.length?this.yieldReturn(t[n++]):i},u.Blank)})},g.prototype.takeExceptLast=function(e){return e==s&&(e=1),this.take(this.getSource().length-e)},g.prototype.takeFromLast=function(e){return this.skip(this.getSource().length-e)},g.prototype.reverse=function(){var e=this.getSource();return new p(function(){var t;return new c(function(){t=e.length},function(){return t>0?this.yieldReturn(e[--t]):i},u.Blank)})},g.prototype.sequenceEqual=function(e,t){return(e instanceof g||e instanceof Array)&&t==s&&p.from(e).count()!=this.count()?i:p.prototype.sequenceEqual.apply(this,arguments)},g.prototype.toJoinedString=function(e,t){var n=this.getSource();return t==s&&n instanceof Array?(e==s&&(e=""),n.join(e)):p.prototype.toJoinedString.apply(this,arguments)},g.prototype.getEnumerator=function(){var e=this.getSource(),t=-1;return{current:function(){return e[t]},moveNext:function(){return++t<e.length},dispose:u.Blank}};var y=function(e,t){this.prevSource=e,this.prevPredicate=t};y.prototype=new p,y.prototype.where=function(e){e=f.createLambda(e);if(e.length<=1){var t=this.prevPredicate,n=function(n){return t(n)&&e(n)};return new y(this.prevSource,n)}return p.prototype.where.call(this,e)},y.prototype.select=function(e){return e=f.createLambda(e),e.length<=1?new b(this.prevSource,this.prevPredicate,e):p.prototype.select.call(this,e)},y.prototype.getEnumerator=function(){var e=this.prevPredicate,t=this.prevSource,n;return new c(function(){n=t.getEnumerator()},function(){while(n.moveNext())if(e(n.current()))return this.yieldReturn(n.current());return i},function(){f.dispose(n)})};var b=function(e,t,n){this.prevSource=e,this.prevPredicate=t,this.prevSelector=n};b.prototype=new p,b.prototype.where=function(e){return e=f.createLambda(e),e.length<=1?new y(this,e):p.prototype.where.call(this,e)},b.prototype.select=function(e){var t=this;e=f.createLambda(e);if(e.length<=1){var n=t.prevSelector,r=function(t){return e(n(t))};return new b(t.prevSource,t.prevPredicate,r)}return p.prototype.select.call(t,e)},b.prototype.getEnumerator=function(){var e=this.prevPredicate,t=this.prevSelector,n=this.prevSource,r;return new c(function(){r=n.getEnumerator()},function(){while(r.moveNext())if(e==s||e(r.current()))return this.yieldReturn(t(r.current()));return i},function(){f.dispose(r)})};var w=function(){var e=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n=function(e){return e===s?"null":e===t?"undefined":typeof e.toString===a.Function?e.toString():Object.prototype.toString.call(e)},r=function(e,t){var n=this;n.key=e,n.value=t,n.prev=s,n.next=s},f=function(){this.first=s,this.last=s};f.prototype={addLast:function(e){var t=this;t.last!=s?(t.last.next=e,e.prev=t.last,t.last=e):t.first=t.last=e},replace:function(e,t){e.prev!=s?(e.prev.next=t,t.prev=e.prev):this.first=t,e.next!=s?(e.next.prev=t,t.next=e.next):this.last=t},remove:function(e){e.prev!=s?e.prev.next=e.next:this.first=e.next,e.next!=s?e.next.prev=e.prev:this.last=e.prev}};var l=function(e){var t=this;t.countField=0,t.entryList=new f,t.buckets={},t.compareSelector=e==s?u.Identity:e};return l.prototype={add:function(t,i){var s=this,o=s.compareSelector(t),u=n(o),a=new r(t,i);if(e(s.buckets,u)){for(var f=s.buckets[u],l=0;l<f.length;l++)if(s.compareSelector(f[l].key)===o){s.entryList.replace(f[l],a),f[l]=a;return}f.push(a)}else s.buckets[u]=[a];s.countField++,s.entryList.addLast(a)},get:function(r){var i=this,s=i.compareSelector(r),o=n(s);if(!e(i.buckets,o))return t;for(var u=i.buckets[o],a=0;a<u.length;a++){var f=u[a];if(i.compareSelector(f.key)===s)return f.value}return t},set:function(t,s){var u=this,a=u.compareSelector(t),f=n(a);if(e(u.buckets,f))for(var l=u.buckets[f],c=0;c<l.length;c++)if(u.compareSelector(l[c].key)===a){var h=new r(t,s);return u.entryList.replace(l[c],h),l[c]=h,o}return i},contains:function(t){var r=this,s=r.compareSelector(t),u=n(s);if(!e(r.buckets,u))return i;for(var a=r.buckets[u],f=0;f<a.length;f++)if(r.compareSelector(a[f].key)===s)return o;return i},clear:function(){this.countField=0,this.buckets={},this.entryList=new f},remove:function(t){var r=this,i=r.compareSelector(t),s=n(i);if(!e(r.buckets,s))return;for(var o=r.buckets[s],u=0;u<o.length;u++)if(r.compareSelector(o[u].key)===i){r.entryList.remove(o[u]),o.splice(u,1),o.length==0&&delete r.buckets[s],r.countField--;return}},count:function(){return this.countField},toEnumerable:function(){var e=this;return new p(function(){var t;return new c(function(){t=e.entryList.first},function(){if(t!=s){var e={key:t.key,value:t.value};return t=t.next,this.yieldReturn(e)}return i},u.Blank)})}},l}(),E=function(e){var t=this;t.count=function(){return e.count()},t.get=function(t){return p.from(e.get(t))},t.contains=function(t){return e.contains(t)},t.toEnumerable=function(){return e.toEnumerable().select(function(e){return new S(e.key,e.value)})}},S=function(e,t){this.key=function(){return e},g.call(this,t)};S.prototype=new g,typeof define===a.Function&&define.amd?define("linqjs",[],function(){return p}):typeof module!==a.Undefined&&module.exports?module.exports=p:e.Enumerable=p})(this),define("scalejs.linq-linqjs",["scalejs!core","linqjs"],function(e,t){e.registerExtension({linq:{enumerable:t}})}),define("scalejs.statechart-scion/state.builder",["scalejs!core","scion"],function(e,t){return function(n){function v(e){return f(function(t){if(t.onEntry)throw new Error("Only one `onEntry` action is allowed.");if(typeof e!="function")throw new Error("`onEntry` takes a function as a parameter.");return t.onEntry=e,t})}function m(e){return f(function(t){if(t.onExit)throw new Error("Only one `onExit` action is allowed.");if(typeof e!="function")throw new Error("`onExit` takes a function as a parameter.");return t.onExit=e,t})}function g(e){return f(function(t){t.event=e})}function y(e){return f(function(t){t.cond=e})}function b(e,t,n){return f(function(i){if(o(i)==="state")return d(b(e,t,n))(i);e&&(i.type="internal"),typeof t=="function"?i.onTransition=t:(i.target=s(t,"array")?t:t.split(" "),n&&(i.onTransition=n))})}function w(e,t){return b(!1,e,t)}function E(e,t){return b(!0,e,t)}function S(e){if(typeof e=="function")return f(function(t){t.onTransition=e});if(e.kind==="$yield")return e;throw new Error("Unsupported transition action",e)}function x(){var e=r.copy(arguments),t=e.pop(),n;if(e.length>2)throw new Error("First (optional) argument should be event name, second (optional) argument should be a condition function");if(typeof t!="function"&&t.kind!=="$yield")throw new Error("Last argument should be either `goto` or a function.");return n=e.map(function(e){if(typeof e=="string")return g(e);if(typeof e=="function")return y(e);throw new Error("Transition argument ",e," is not supported. First (optional) argument should be event name, second (optional) argument should be a condition function")}),f(d.apply(null,n.concat([S(t)])))}function T(){var e=r.copy(arguments),t=e.pop();e.forEach(function(e){if(typeof e!="string")throw new Error("`whenInStates` accepts list of states and either `goto` or a function as the last argument.")});if(typeof t!="function"&&t.kind!=="$yield")throw new Error("Last argument should be either `goto` or a function.");return f(d(y(function(t,n){return e.every(function(e){return n(e)})}),t))}function N(){var e=r.copy(arguments),t=e.pop();e.forEach(function(e){if(typeof e!="string")throw new Error("`whenNotInStates` accepts list of states and either `goto` or a function as the last argument.")});if(typeof t!="function")throw new Error("Last argument should be either `goto` or a function.");return f(d(y(function(t,n){return e.every(function(e){return!n(e)})}),t))}function C(e){return f(function(t){if(t.parallel)return new Error("`initial` shouldn't be specified on parallel region.");t.initial=e})}function k(n){return function(){var i=h.apply(null,arguments);return new t.Statechart(i,u({log:e.log.debug},n))}}var r=e.array,i=e.object.has,s=e.type.is,o=e.type.typeOf,u=e.object.merge,a=e.functional.builder,f=a.$yield,l,c,h,p,d;return l=a({run:function(e,t){var n=new function(){};return i(t,"parallel")&&(n.type="parallel"),e(n),n},delay:function(e){return e()},zero:function(){return function(){}},$yield:function(e){return e},combine:function(e,t){return function(n){e(n),t(n)}},missing:function(e){if(typeof e=="string")return function(t){if(t.id)throw new Error("Can't set state id to \""+e+'". '+"state's id is already set to \""+t.id+'"');t.id=e};if(typeof e=="function")return e;if(o(e)==="state")return function(t){t.states||(t.states=[]),t.states.push(e)};throw new Error("Missing builder for expression",e)}}),h=l(),p=l({parallel:!0}),c=a({run:function(e){return function(t){t.transitions||(t.transitions=[]);var n={};e(n),t.transitions.push(n)}},delay:function(e){return e()},zero:function(){return function(){}},$yield:function(e){return e},combine:function(e,t){return function(n){e(n),t(n)}},missing:function(e){if(typeof e=="function")return e;throw new Error('Unknown operation "'+e.kind+'" in transition expression',e)}}),d=c(),{builder:k,state:h,parallel:p,initial:C,onEntry:v,onExit:m,on:x,whenInStates:T,whenNotInStates:N,"goto":w,gotoInternally:E,statechart:k({logStatesEnteredAndExited:n.logStatesEnteredAndExited,log:e.log.debug})}}}),define("scalejs.statechart-scion/state",["scalejs!core","./state.builder","scion"],function(e,t,n){return function(r){function v(e){return u(e,"states")?i.make(e).concat(i.from(e.states).selectMany(v)):i.make(e)}function m(e,t){var n=v(e).firstOrDefault(function(e){return e.id===t});return n}function g(e,t){var n=v(e).firstOrDefault(function(e){return e.states&&e.states.some(function(e){return e.id===t})});return n}function y(){return f(function(e,t){var n,r;n=m(p,e);if(!n)throw new Error('Parent state "'+e+"\" doesn't exist");if(u(t,"id")){r=m(p,t.id);if(r)throw new Error('State "'+t.id+'" already exists.')}u(n,"states")||(n.states=[]),n.states.push(t)}).apply(null,arguments)}function b(t){if(e.isApplicationRunning())throw new Error("Can't register a state while application is running.");s(arguments,1).forEach(y(t))}function w(){if(e.isApplicationRunning())throw new Error("Can't unregister a state while application is running.");s(arguments).forEach(function(e){var t=g(p,e),n=i.from(t.states).first(function(t){return t.id===e});o(t.states,n)})}function E(e,t,n){var r;if(a(e,"string"))r={name:e};else{if(!a(e,"name"))throw new Error("event object should have `name` property.");r=e}!u(n)&&a(t,"number")?n=t:r.data=t,d.send(r,{delay:n})}var i=e.linq.enumerable,s=e.array.toArray,o=e.array.removeOne,u=e.object.has,a=e.type.is,f=e.functional.curry,l=t(r),c=l.state,h=l.parallel,p,d;return p=c("scalejs-app",h("root")),e.onApplicationEvent(function(t){switch(t){case"started":d=new n.Statechart(p,{logStatesEnteredAndExited:r.logStatesEnteredAndExited,log:e.log.debug}),d.start();break;case"stopped":}}),{registerStates:b,unregisterStates:w,raise:E,builder:l}}}),define("scalejs.statechart-scion",["scalejs!core","./scalejs.statechart-scion/state","module"],function(e,t,n){e.registerExtension({state:t(n.config())})});